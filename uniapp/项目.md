## è¯·æ±‚æ–¹æ³•å°è£…

> ä¸ºäº†å‡å°‘ä»£ç çš„å†—ä½™ï¼Œä¼˜åŒ–ä»£ç çš„å¯è¯»æ€§ï¼ŒåŠå¯ç»´æŠ¤æ€§ï¼Œè¿›è¡Œè¯·æ±‚æ–¹æ³•çš„å°è£…

### å®ç°æµç¨‹

#### ä¸€ã€å®šä¹‰å…¬å…±çš„httpè¯·æ±‚æ–¹æ³•

1. åˆ›å»ºhttp.jsæ–‡ä»¶ï¼Œå¯¼å‡ºä¸€ä¸ªå°è£…å¥½çš„promiseå¯¹è±¡ï¼ˆå†…éƒ¨è¿›è¡ŒuniCloudè°ƒç”¨)

   ```js
   export default ({name,data={}})=> {
   	/* å¯¼å‡ºpormiseå¯¹è±¡ */
   	return new Promise((resolve,reject) => {
   		uni.showLoading({
   		})
   		uniCloud.callFunction({
   			name,
   			success({result}) {
   				if(result.code === 0) {
   					resolve(result.data)
   				}else {
   					uni.showToast({icon:"none",title:result.msg})
   				}
   			},
   			fail(err) {
   				reject(err)
   			},
   			complete() {
   				uni.hideLoading()
   			}
   		})
   	})
   }
   ```

#### äºŒã€åˆ›å»ºæ¥å£æ–‡ä»¶è¿›è¡Œå…¬å…±æ–¹æ³•çš„è°ƒç”¨

<img src="https://tva1.sinaimg.cn/large/008i3skNly1gsxstw207mj30tw0bw3zk.jpg" alt="image-20210729142301526" style="zoom:50%;" />

#### ä¸‰ã€æ–¹æ³•æŒ‚è½½åˆ°VueåŸå‹ä¸Šï¼Œä¾›æ¯ä¸ªç•Œé¢è¿›è¡Œä½¿ç”¨ 

1. **ä½¿ç”¨webpacckçš„require.contextæ–¹æ³•å¯¹æ‰€æœ‰çš„è¯·æ±‚å‡½æ•°æ”¶é›†**

   > require.contextæ˜¯ä»€ä¹ˆï¼Ÿ
   >
   > ä¸€ä¸ªwebpackçš„api,é€šè¿‡æ‰§è¡Œrequire.contextå‡½æ•°è·å–ä¸€ä¸ªç‰¹å®šçš„ä¸Šä¸‹æ–‡,ä¸»è¦ç”¨æ¥å®ç°è‡ªåŠ¨åŒ–å¯¼å…¥æ¨¡å—,åœ¨å‰ç«¯å·¥ç¨‹ä¸­,å¦‚æœé‡åˆ°ä»ä¸€ä¸ªæ–‡ä»¶å¤¹å¼•å…¥å¾ˆå¤šæ¨¡å—çš„æƒ…å†µ,å¯ä»¥ä½¿ç”¨è¿™ä¸ªapi,å®ƒä¼šéå†æ–‡ä»¶å¤¹ä¸­çš„æŒ‡å®šæ–‡ä»¶,ç„¶åè‡ªåŠ¨å¯¼å…¥,ä½¿å¾—ä¸éœ€è¦æ¯æ¬¡æ˜¾å¼çš„è°ƒç”¨importå¯¼å…¥æ¨¡å—

   ```js
   /* æ‰¹é‡è¿›è¡Œæ–‡ä»¶å¯¼å‡º */
   // . =>APIç›®å½•çš„ç›¸å¯¹è·¯å¾„
   // true => æ˜¯å¦æŸ¥è¯¢å­ç›®å½•
   // /.js/ => éœ€è¦æŸ¥è¯¢çš„æ–‡ä»¶çš„åç¼€å
   
   const requireApi = require.context('.', true, /.js$/);
   console.log(requireApi.keys())
   let module = {};
   
   requireApi.keys().forEach((key, index) => {
   	if (key === './index.js') return
   	Object.assign(module, requireApi(key))
   })
   
   export default module
   ```

2. **main.jsè¿›è¡Œæ–¹æ³•æŒ‚è½½**

   ```react
   import module from './ajax/api/index.js'
   Vue.prototype.$http = module;
   ```

   

#### å››ã€é¡µé¢/ç»„ä»¶å†…éƒ¨è¿›è¡Œæ–¹æ³•çš„è°ƒç”¨

```js
async _intiLabelList() {
				const labelList = await this.$http.get_label_list()
				this.labelList = labelList
			}
```







## æ–‡ç« åˆ—è¡¨åˆ¶ä½œ-å®¹å™¨ç»„ä»¶



#### ä¸€ã€å®šä¹‰articleListç»„ä»¶

1. **ä½¿ç”¨swiperç»„ä»¶å®ç°æ»šåŠ¨æ•ˆæœ** https://uniapp.dcloud.io/component/swiper

   1. swiperItemæ•°é‡åŠ¨æ€è¯ï¼Œå½“å‰çš„swiperæ•°é‡åº”è¯¥ä¸é€‰é¡¹å¡çš„æ•°é‡ç›¸åŒ

      è·å–é€‰é¡¹å¡çš„æ•°é‡å€¼ï¼Œæ ¹æ®é€‰é¡¹å¡æ•°é‡è¿›è¡ŒswiperItemæ¸²æŸ“,indexç•Œé¢è¿›è¡ŒlabelListä¼ é€’

      ```react
      		<ArticleList :labelList="labelLIst" class="list-container"></ArticleList>
      ```

   2. ArticleListå†…æ ¹æ®swiperæ•°é‡è¿›è¡ŒswiperItemæ¸²æŸ“

      ```react
       <swiper class="swiper-container">
          <swiper-item v-for="(item,index) in labelList" :key="index">
            <view class="swiper-item uni-bg-red">
              <list-item></list-item>
            </view>
          </swiper-item>
        </swiper>
      ```

      

2. **é€‰é¡¹å¡ä¸swiperç»„ä»¶è”åŠ¨æ•ˆæœå®ç°**

   1. é€‰é¡¹å¡ç‚¹å‡»äº‹ä»¶ç»‘å®š

      å‘é€äº‹ä»¶ï¼Œè°ƒæ•´activeIndexå€¼ï¼Œå°†activeIdnexå€¼è°ƒæ•´ä¸ºçˆ¶ç»„ä»¶ä¼ é€’å€¼

      swiperåˆ¶å®šcurrentå±æ€§ï¼Œå€¼ä¸ºactiveIndex

   2. swiper changeäº‹ä»¶ç›‘å¬ï¼Œå®ç°æ”¹å˜activeIndexå±æ€§

      ```react
       <swiper class="swiper-container" :current="activeIndex" @change="changCurrentIndex">
          <swiper-item v-for="(item,index) in labelList" :key="index">
            <view class="swiper-item uni-bg-red">
              <list-item></list-item>
            </view>
          </swiper-item>
        </swiper>
        
      <script>
        	 methods:{
            changeCurrentIndex(e) {
                const {current}  = e.detail;
                this.$emit('changeCurrentIndex',current)
           	 }
        		}
      </script>
      ```

      

#### äºŒã€é€‰é¡¹å¡è‡ªåŠ¨è¿›è¡Œä½ç½®è°ƒæ•´

1. scroll-view ç»„ä»¶æ·»åŠ å±æ€§ scroll-with-animationåŠ scroll-left å±æ€§  https://uniapp.dcloud.io/component/scroll-view

2. åŠ¨æ€è®¾ç½®scrollintoviewå±æ€§ï¼Œä¸ºæ¯ä¸€é¡¹æ·»åŠ IDå±æ€§è¿›è¡Œè·³è½¬åˆ‡æ¢

   ```react
    <scroll-view class="tab-scroll" scroll-x="true" :scroll-into-view="currentIndex" :scroll-with-animation="true">
         <view class="tab-scroll-box">
           <view :id="`item${index}`" @click="navClickFn(index)" :class="{active:activeIndex === index}" v-for="(item, index) in labelList" :key="index" class="tab-scroll-item">{{ item.name}}</view>
         </view>
       </scroll-view>
   
   <script>
      watch:{
   	  activeIndex(index){
   		this.currentIndex = `item${index}`
   	  }
     },
     data() {
       return {
   		currentIndex:''
       }
     }
   </script>
   ```

3. é€šè¿‡watchå±æ€§ç›‘å¬currIndexå€¼æ”¹å˜ï¼Œè¿›è¡ŒcurrentIndexè®¾å®š







## æ–‡ç« åˆ—è¡¨åˆ¶ä½œ-æ–‡ç« å¡ç‰‡



#### ä¸€ã€åˆ›å»ºæ–‡ç« ç›¸å…³listItemç»„ä»¶

> â€‹	ä½¿ç”¨scroll-view å®ç°ç«–å‘æ»šåŠ¨å®¹å™¨åˆ¶ä½œï¼Œæ³¨æ„åœ¨æ ·å¼å®šä¹‰æ—¶è¿›è¡Œå¤šçº§é«˜åº¦è®¾å®š

```vue
<view class="list-scroll-container">
		<scroll-view scroll-y="true" class="list-scroll">
			<view>
				<ListCard v-for="item in 50" :key="item"></ListCard>
			</view>
		</scroll-view>
</view>
```

#### äºŒã€æ–‡ç« å¡ç‰‡ç»„ä»¶å®šä¹‰

1. åˆ›å»ºåŸºæœ¬æ ·å¼åŠç»“æ„

2. å®šä¹‰å¤šçŠ¶æ€å¡ç‰‡æ¨¡å—

   1. é€šè¿‡çˆ¶ç»„ä»¶ä¼ é€’modeå±æ€§è¿›è¡Œæ¡ä»¶ç¼–è¯‘

   2. æ ¹æ®æ¡ä»¶è¿›è¡Œé€‰é¡¹å¡å¡ç‰‡å±•ç¤º




#### ä¸‰ã€å®šä¹‰uniappæ¨¡ç‰ˆ

1. æ ¹ç›®å½•ä¸‹åˆ›å»ºindex.htmlæ–‡ä»¶

2. å‚è€ƒåœ°å€ï¼šhttps://uniapp.dcloud.io/collocation/manifest?id=h5-template

3. manifestæ–‡ä»¶çš„html5é…ç½®ä¸­è¿›è¡Œindex.htmlæ–‡ä»¶å¼•å…¥

   

   

   

â€‹	



## æ–‡ç« åˆ—è¡¨åˆ¶ä½œ-æ•°æ®æ¸²æŸ“



#### ä¸€ã€äº‘å‡½æ•°åˆ›å»º

> â€‹	å®šä¹‰articleListäº‘å‡½æ•°
>
> åˆ é™¤ä¸éœ€è¦è¿”å›çš„æ–‡ç« è¯¦æƒ…å†…å®¹

```react
'use strict';
const db = uniCloud.database()
exports.main = async (event, context) => {
	const list = await db.collection('article')
	.aggregate()
	.project({
		content:0
	})
	.end()
	//è¿”å›æ•°æ®ç»™å®¢æˆ·ç«¯
	return {
		code:0,
		msg:"æ•°æ®è¯·æ±‚æˆåŠŸ",
		data:list.data
	}
};

```

#### äºŒã€å‰ç«¯è¿›è¡Œæ•°æ®è·å–

1. articleListç»„ä»¶ => createdé’©å­ä¸­è¿›è¡Œæ•°æ®è·å–

   ```react
   created () {
       this._getArticleList()
     }
    methods: {
       async _getArticleList () {
         const articleList = await this.$http.get_article_list()
         this.articleList = articleList
       }
     }
   ```

#### ä¸‰ã€æ•°æ®æ¸²æŸ“

listItemç»„ä»¶ä¸­è¿›è¡Œå¾ªç¯æ¸²æŸ“ä½¿ç”¨

```react
<view class="list-scroll-container">
		<scroll-view scroll-y="true" class="list-scroll">
			<view>
				<ListCard :item="item" v-for="(item,index) in articleList" :key="index"></ListCard>
			</view>
		</scroll-view>
	</view>
```



#### å››ã€æ ¹æ®é€‰é¡¹å¡åˆ†ç±»è¿›è¡Œæ•°æ®æ¸²æŸ“

1. æ·»åŠ å…¨éƒ¨åˆ†ç±»é€‰é¡¹

   ```react
   async _intiLabelList() {
   				const labelList = await this.$http.get_label_list()
   				this.labelList = [{name:"å…¨éƒ¨"},...labelList]
   			}
   ```

2. è¯·æ±‚articleListæ—¶è¿›è¡Œæ•°æ®ä¼ é€’ 

   1. ä¸ºäº†ä¿è¯å¯¼èˆªæ•°æ®çš„æ­£ç¡®è·å–ï¼Œè°ƒæ•´createdå‡½æ•°çš„_getArticle_listæ–¹æ³•åœ¨watchä¸­è¿›è¡Œè°ƒç”¨

      ```react
       watch: {
          labelList(newVal,OldVal) {
          this._getArticleList()
          },
        },
      ```

      

3. äº‘å‡½æ•°è¿›è¡Œæ•°æ®è¿‡æ»¤è°ƒæ•´

   ```js
   'use strict';
   const db = uniCloud.database()
   exports.main = async (event, context) => {
   	
   	const {classify} = event
   	
   	let matchObj = {}
   	
   	if(classify !== 'å…¨éƒ¨') {
   		matchObj = {classify}
   	}
   	
   	const list = await db.collection('article')
   	.aggregate()   // ä½¿ç”¨èšåˆçš„å½¢å¼è¿›è¡Œæ•°æ®çš„è·å–
   	.match(matchObj)   // æ ¹æ®åŒ¹é…æ¡ä»¶è¿›è¡Œæ•°æ®è¿”å›
   	.project({
   		content:0    // æœ¬æ¬¡æŸ¥è¯¢ä¸éœ€è¦è¿”å›æ–‡ç« è¯¦æƒ…ç»™å‰ç«¯
   	})
   	.end()
   	//è¿”å›æ•°æ®ç»™å®¢æˆ·ç«¯
   	return {
   		code:0,
   		msg:"æ•°æ®è¯·æ±‚æˆåŠŸ",
   		data:list.data
   	}
   };
   
   ```

4. å‰ç«¯å¯¹æ•°æ®è¿›è¡Œç¼“å­˜å¤„ç†

   å°†åŸæœ‰æ¥å—å†…å®¹æ•°ç»„è½¬æ¢ä¸ºå¯¹è±¡è¿›è¡Œå­˜å‚¨ã€‚æ¯æ¬¡changeæ”¹å˜å†…å®¹æ—¶è¿›è¡Œåˆ¤æ–­æ“ä½œå¤„ç†

   ä½¿ç”¨$setæ–¹æ³•è¿›è¡Œå¯¹è±¡çš„é¡µé¢é‡æ–°æ¸²æŸ“

   ```js
   async _getArticleList (currentIndex) {
         const articleList = await this.$http.get_article_list({classify:this.labelList[currentIndex].name})
         this.$set(this.articleData,currentIndex,articleList)
       }
   ```
   
   



## æ–‡ç« åˆ—è¡¨åˆ¶ä½œ-ä¸Šæ‹‰åŠ è½½æ›´å¤š



#### ä¸€ã€ä½¿ç”¨uni-load-moreæ’ä»¶

ä¸‹è½½åœ°å€ï¼šhttps://ext.dcloud.net.cn/plugin?id=29

ä½¿ç”¨ï¼š

```react
<uni-load-more status="loading"></uni-load-more>
```

#### äºŒã€ä¿®æ”¹å‚æ•°ä¼ é€’

1. å‰ç«¯æ·»åŠ pageåŠsizeå±æ€§åˆ°äº‘å‡½æ•°

2. äº‘å‡½æ•°å†…è¿›è¡Œè¿”å›å€¼é™åˆ¶å¤„ç†

   ```js
   const list = await db.collection('article')
   		.aggregate() // ä½¿ç”¨èšåˆçš„å½¢å¼è¿›è¡Œæ•°æ®çš„è·å–
   		.match(matchObj) // æ ¹æ®åŒ¹é…æ¡ä»¶è¿›è¡Œæ•°æ®è¿”å›
   		.project({
   			content: 0 // æœ¬æ¬¡æŸ¥è¯¢ä¸éœ€è¦è¿”å›æ–‡ç« è¯¦æƒ…ç»™å‰ç«¯
   		})
   		.skip(pageSize * (page - 1)) // é¦–é¡µä»0å¼€å§‹è®¡ç®—
   		.limit(pageSize) // æ¯é¡µæœ€å¤šè¿”å›å¤šå°‘æ¡æ•°æ®
   		.end()
   ```

3. ç›‘å¬scroll-viewçš„scrolltoloweräº‹ä»¶ï¼Œè§¦åº•æ—¶è¿›è¡Œæ–°çš„æ•°æ®è¯·æ±‚ï¼Œå½“å‰çš„pageå€¼

4. å‰ç«¯è°ƒæ•´æ•°æ®å¤„ç†å°†ç›´æ¥èµ‹å€¼å˜ä¸ºè¿½åŠ æ•°æ®

   ```js
    // å¡«å……æ•°æ®æ—¶æ”¹å˜ä¸ºè¿½åŠ æ•°æ®
         let oldList = this.articleData[currentIndex] || []
         oldList.push(...articleList)
         this.$set(this.articleData, currentIndex, oldList)
   ```


#### ä¸‰ã€åˆ†ç±»é¡µæ•°å¤„ç†

1. åˆ›å»ºæ¯ä¸€ä¸ªåˆ†ç±»çš„å­˜å‚¨å¯¹è±¡ï¼Œå«pageåŠåŠ è½½çŠ¶æ€

   ```js
   loadData:{
   	page:1,
   	loading:loading
   }
   ```

2. å¤„ç†æ•°æ®å…¨éƒ¨åŠ è½½å®ŒæˆçŠ¶æ€

   ```react
   // åˆ¤æ–­å½“å‰åç«¯æ²¡æœ‰è¿”å›æ•°æ®å¤„ç† 
         if(!articleList.length) {
           this.loadData[currentIndex] = {
             loading:"noMore",
             page:this.loadData[currentIndex].page
           }
           this.$forceUpdate()
           return 
         }
   ```

   



## ç”¨æˆ·ç™»å½•-ç™»å½•ç•Œé¢æ­å»º



#### ä¸€ã€ç»“æ„æ ·å¼ä»£ç ç¼–å†™

1. uni-formsæ’ä»¶ä¸‹è½½

   **ä¸‹è½½åœ°å€**ï¼šhttps://ext.dcloud.net.cn/plugin?id=2773

2. send-codeç»„ä»¶å°è£…

   1. ç»“æ„å¤„ç†

      ```js
      <template>
        <view class="code-container">
          <view class="vCode-btn" @click="getForm">
            {{runTime? `${time}ç§’åé‡æ–°è·å–`:'è·å–éªŒè¯ç '}}
          </view>
        </view>
      </template>
      ```

   2. å®šæ—¶å™¨åˆ›å»º

   3. ç»„ä»¶é”€æ¯æ—¶ï¼Œè¿›è¡Œå‰¯ä½œç”¨ï¼ˆå®šæ—¶å™¨ï¼‰æ¸…é™¤æ“ä½œ

      ```js
      // ç¦»å¼€ç•Œé¢æ—¶è¿›è¡Œå®šæ—¶å™¨çš„æ¸…é™¤æ“ä½œ
        beforeDestroy () {
          clearInterval(this.timeId)
          this.timeId = null
          this.runTime = false
          this.time = 60
        },
      ```

      

   













## ç”¨æˆ·ç™»å½•-è¡¨å•éªŒè¯



#### ä¸€ã€userRulesMixinæ–‡ä»¶ä½¿ç”¨

1. commonæ–‡ä»¶å¤¹ä¸‹åˆ›å»ºuserRulesMixin

```react
export default {
  install (Vue) {   // ä½¿ç”¨installçš„å½¢å¼è¿›è¡Œå®‰è£…mixin
    Vue.mixin({
      data () {
        return {
          a:'hello world'
        }
      },
      methods: {
        test () {

        }
      }
    })
  }
}
```

2. main.jsä¸­ä½¿ç”¨mixinæ–‡ä»¶

   ```react
   import userMixin from './common/rulesMixin.js'
   Vue.use(userMixin)
   ```

3. ç»„ä»¶æˆ–é¡µé¢å†…ç›´æ¥è¿›è¡Œä½¿ç”¨

   ```react
     onLoad: function () {
       console.log(this.test())
     }
   ```

#### äºŒã€éªŒè¯è§„åˆ™ç¼–å†™

```react
  userRules: {
            loginName: {
              rules: [
                { required: true, 'errorMessage': "è´¦æˆ·åä¸èƒ½ä¸ºç©º" },
                {
                  validateFunction: (rule, val, data, callback) => {
                    switch (true) {
                      case val.length < 6:
                        callback('ç”¨æˆ·åé•¿åº¦ä¸æ­£ç¡®')
                        break;
                      default:
                        return true
                    }
                  }
                }   // è‡ªå®šä¹‰éªŒè¯è§„åˆ™
              ]
            }
          }
```



**æ‰‹æœºå·ç æ­£åˆ™è¡¨è¾¾å¼**

```css
/^(0|86|17951)?(13[0-9]|15[012356789]|166|17[3678]|18[0-9]|14[57])[0-9]{8}$/
```









## ç”¨æˆ·ç™»å½•-è´¦æˆ·åå¯†ç ç™»å½•



#### ä¸€ã€å‰ç«¯æ•°æ®æ•´ç†

1. å®šä¹‰å‘é€å‡½æ•°ï¼Œå°†ç”¨æˆ·ä¿¡æ¯ä»¥åŠæœ¬æ¬¡è¯·æ±‚çš„ç”¨æˆ·ç™»å½•ç±»å‹ä¼ é€’ç»™åç«¯

   ```react
     this._sendUserInfo({ ...res, type: this.type })
   ```

2. åˆ›å»ºè¯·æ±‚æ–¹æ³• user_login

3. å®šä¹‰user_loginå‡½æ•°

   ```react
   'use strict';
   // è·å–æ•°æ®åº“å¼•ç”¨
   const db = uniCloud.database()
   exports.main = async (event, context) => {
     const { loginName, password, phone, type } = event;
   	
     const { affectedDocs, data } = await db.collection('user')
       .aggregate()
       .match(type === 'account' ? { loginName, password } : { phone })
       .end()
   	
     //è¿”å›æ•°æ®ç»™å®¢æˆ·ç«¯
     return affectedDocs ? {
       code: 0,
       msg: "è·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸ",
       data: data[0]
     } : {
       code: 1,
       msg: type === 'account' ? 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åæˆ–å¯†ç ' : 'éªŒè¯ç æˆ–æ‰‹æœºå·ç é”™è¯¯'
     }
   };
   
   ```

4. å‰ç«¯æ¥æ”¶è¿”å›ä¿¡æ¯ï¼Œè¿›è¡Œæ•°æ®å¤„ç†
   1. è·³è½¬ç•Œé¢åˆ°ä¸Šä¸€ä¸ªå†å²è®°å½•
   2. å­˜å‚¨ç”¨æˆ·ä¿¡æ¯

#### äºŒã€ä½¿ç”¨storeè¿›è¡Œç”¨æˆ·ä¿¡æ¯å­˜å‚¨

1.  åˆ›å»ºå®ä¾‹åŒ–Storeå¯¹è±¡	

   ```react
   import Vue from 'vue'
   import VueX from 'vuex'
   import state from './state.js'
   import mutations from './mutations.js'
   import actions from './actions.js'
   
   
   Vue.use(VueX)
   
   export default new VueX.Store({
     state,
     actions,
     mutations
   })
   ```

2. main.jsä¸­è¿›è¡Œstoreæ³¨å†Œ

3. è·å–ç”¨æˆ·ä¿¡æ¯ä¹‹åï¼Œè¿›è¡Œç”¨æˆ·ä¿¡æ¯ä¿å­˜æ“ä½œ

   ```js
   // login.vue
   
      async _sendUserInfo (data) {
         const res = await this.$http.user_login(data)
         if (res) {
           this.updateUserInfo(res)
           uni.showToast({
             title: 'ç™»å½•æˆåŠŸ', icon: 'none',
           })
           setTimeout(() => { 
              // #ifdef H5
             uni.switchTab({
               url: '/pages/index/index'
             })
             // #endif
             // #ifndef H5
             uni.navigateBack()
             // #endif
           }, 2000)
         }
       }
       
   // mutation.js
   
   export default {
     updateUserInfo(state,userInfo) {
       uni.setStorageSync('userInfo',userInfo);
       state.userInfo = userInfo;
     }
   }
   ```
   
   â€‹	





## ç”¨æˆ·ç™»å½•-æ‰‹æœºéªŒè¯ç ç™»å½•



#### ä¸€ã€éªŒè¯ç å¤„ç†

1. è·å–æ‰‹æœºéªŒè¯çŠ¶æ€

2. ä¿è¯send-codeè·å–formå¯¹è±¡

   ```react
   // SendCode.vue  
   this.$emit('getForm', form => this._sendCode(form))
   ```

3. é€šè¿‡formè¿›è¡Œæ‰‹æœºå·ç å•ç‹¬éªŒè¯ï¼Œå¹¶è·å–æ‰‹æœºå·ç 

   ```js
   const { phone } = await form.validateField(['phone']);
   ```

4. å¯åŠ¨å®šæ—¶å™¨ï¼Œè°ƒæ•´æ–‡æœ¬æ˜¾ç¤ºå†…å®¹

   ```js
    const timeId = setInterval(() => {
           if (this.time === 1) {
             clearInterval(timeId)
             this.runTime = false
             this.time = 60
             return
           }
           this.time--
         }, 1000)
   ```

#### äºŒã€æ•°æ®å‘é€

1. æ•°æ®å‘é€ï¼Œåˆ›å»ºäº‘å‡½æ•°

2. å®šä¹‰unicloudçŸ­ä¿¡æœåŠ¡

   1. unicloudå¼€å‘ä¸­å¿ƒåœ°å€ï¼šhttps://dev.dcloud.net.cn/uniSms
   2. çŸ­ä¿¡å‚è€ƒé…ç½®åœ°å€ï¼šhttps://uniapp.dcloud.net.cn/uniCloud/send-sms

3. å‰ç«¯æ¥å—è¿”å›å€¼ï¼Œä¿å­˜éªŒè¯ç ï¼ŒåŠ å…¥éªŒè¯ç éªŒè¯è§„åˆ™

4. æäº¤ç”¨æˆ·æ•°æ®å‘é€ï¼ŒæŒ‡å®šå‚æ•°phoneåŠ typeç±»å‹

   




## æ”¶è—æŒ‰é’®ç»„ä»¶å®ç°

### ä¸€ã€å‰ç«¯å¤„ç†

1. æ”¶è—å›¾æ ‡ç‚¹å‡»äº‹ä»¶å†…è·å–ç”¨æˆ·ä¿¡æ¯ï¼ŒåŠæ–‡ç« ä¿¡æ¯ï¼Œä¼ é€’åˆ°åç«¯

   ç”±äºå¤šä¸ªç•Œé¢ä¸­éƒ½ä¼šç”¨åˆ°userInfoå¯¹è±¡ï¼Œå¯å°†userInfoå¯¹è±¡æ”¾åœ¨ä¸€ä¸ªå…¨å±€çš„mixinä¸­è¿›è¡Œå°å­˜ï¼Œä¿è¯æ¯ä¸ªç•Œé¢æˆ–ç»„ä»¶å†…éƒ¨éƒ½å¯ä»¥è¿›è¡Œä½¿ç”¨

   1. å®šä¹‰commonMixinæ–‡ä»¶

      ```js
      import { mapState } from 'vuex'
      
      export default {
        install (Vue) {
          Vue.mixin({
            computed: {
              ...mapState(['userInfo'])
            }
          })
        }
      }
      ```

   2. main.jsæ–‡ä»¶ä¸­å¯¹common Mixingæ–‡ä»¶è¿›è¡Œä½¿ç”¨

      ```js
      // main.js
      import commonMixin from './common/commonMixin.js'
      Vue.use(commonMixin)
      ```

      

2. å°†ç”¨æˆ·IDåŠæ–‡ä»¶IDä½œä¸ºå‚æ•°ä¼ é€’ç»™äº‘å‡½æ•°

   1. åˆ›å»ºå…¨å±€æ£€æµ‹ç”¨æˆ·æ˜¯å¦ç™»å½•å‡½æ•°ï¼Œä¾›å¤šä¸ªç»„ä»¶è¿›è¡Œä½¿ç”¨ï¼ŒcommonMixinä¸­å®Œæˆ

      ```js
      // commonMixinæ–‡ä»¶
      checkedIsLogin () {
                return new Promise(resolve => {
                  if (this.userInfo) {
                    resolve()
                  } else {
                    uni.navigateTo({
                      url: '/pages/userInfo/login/login'
                    })
                  }
                })
              }
      // saveLikeç»„ä»¶
      await this.checkedIsLogin();
      ```

   2. å°†æ–‡ç« ä¿¡æ¯ä¼ é€’åˆ°saveLikeç»„ä»¶å†…éƒ¨ä½¿ç”¨

      ```js
      //listCard ç»„ä»¶
      <SaveLikes :item="item"></SaveLikes>
      // saveLikeç»„ä»¶
       props: {
          item: Object
        }
      ```

   3. å‘é€æ•°æ®åˆ°äº‘æœåŠ¡å™¨

      ```js
       const res = await this.$http.upate_save_like({
              articleId: this.item._id,
              userId: this.userInfo._id
            })
      ```

   

### äºŒã€äº‘å‡½æ•°å®šä¹‰

1. è·å–ç”¨æˆ·è®°å½•å€¼

2. æ‰¾åˆ°æŒ‡å®šå­—æ®µarticle_likes_ids

3. é€šè¿‡db.command æ›´æ–°æŒ‡ä»¤ä¿®æ”¹article_likes_ids

   å‚è€ƒåœ°å€ï¼šhttps://uniapp.dcloud.io/uniCloud/cf-database?id=query-command

   - å½“æ–‡ç« idå­˜åœ¨ï¼Œè¿›è¡Œåˆ é™¤æ“ä½œï¼Œä½¿ç”¨pullæ–¹æ³• å‚è€ƒåœ°å€ï¼šhttps://uniapp.dcloud.io/uniCloud/cf-database?id=pull
   - å½“æ–‡ç« idä¸å­˜åœ¨ï¼Œè¿›è¡Œæ·»åŠ æ“ä½œï¼Œä½¿ç”¨addToSetæ–¹æ³• å‚è€ƒåœ°å€:https://uniapp.dcloud.io/uniCloud/cf-database?id=addtoset

4. å¤„ç†å®Œæˆï¼Œå°†article_likes_idsè¿›è¡Œä¿®æ”¹ä¹‹åï¼Œé‡æ–°å­˜å‚¨

   ```js
   'use strict';
   // å®šä¹‰æ•°æ®åº“å¼•ç”¨
   const db = uniCloud.database();
   // å®šä¹‰ä¿®æ”¹æŒ‡ä»¤
   const dbCmd = db.command
   
   exports.main = async (event, context) => {
   	const {
   		userId,
   		articleId
   	} = event
   	// è·å–ç”¨æˆ·Idsé›†åˆ
   	const userInfo = await db.collection('user').doc(userId).get();
   
   	const articleIds = userInfo.data[0].article_likes_ids
   	let returnMsg = null
   
   	let articleArr = null;
   	// å¦‚æœåŒ…å«åˆ é™¤æ”¶è—
   	if (articleIds.includes(articleId)) {
   		articleArr = dbCmd.pull(articleId)
   		returnMsg = 'å–æ¶ˆæ”¶è—æˆåŠŸ'
   	} else {
   		articleArr = dbCmd.addToSet(articleId)
   		returnMsg = 'æ·»åŠ æ”¶è—æˆåŠŸ'
   	}
   
   	await db.collection('user').doc(userId).update({
   		article_likes_ids: articleArr
   	})
   
   	const updateUserInfo = await db.collection('user').doc(userId).get()
   
   	//è¿”å›æ•°æ®ç»™å®¢æˆ·ç«¯
   	return {
   		code: 0,
   		data: {
   			msg: returnMsg,
   			newUserInfo:updateUserInfo.data[0]
   		}
   	}
   };
   
   ```

### è·å–æ•°æ®åå‰ç«¯å¤„ç†

1. ä¿®æ”¹å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯article_likes_idsæ•°ç»„

   ```js
   // saveLikesç»„ä»¶å¤„ç†
   this.updateUserInfo({ ...this.userInfo, ...newUserInfo })
   ```

2. å¼¹å‡ºæç¤ºä¿¡æ¯

3. é‡æ–°å¯¹ä¿å­˜çŠ¶æ€iconå›¾æ ‡èµ‹å€¼

   ä½¿ç”¨è®¡ç®—å±æ€§å¤„ç†ç”¨æˆ·æ”¶è—ä¿å­˜çŠ¶æ€

   ```js
    computed: {
       isLike () {
         return this.userInfo && this.userInfo.article_likes_ids.includes(this.item._id)
       }
     }
   ```

   





## æœç´¢é¡µé¢-ç»“æ„æ­å»º

### ä¸€ã€è°ƒæ•´navBarä¸ºåŠ¨æ€ç»„ä»¶

> æ·»åŠ æ˜¯å¦ä¸ºæœç´¢ç•Œé¢åˆ¤æ–­

1. isSearchï¼Œå½“ç•Œé¢ä¸ºæœç´¢ç•Œé¢æ—¶ï¼Œæ·»åŠ è¿”å›iconå›¾æ ‡

```html
 <!--å½“ç•Œé¢ä¸ºæœç´¢ç•Œé¢çš„æ—¶å€™ï¼Œæ·»åŠ å›é€€æŒ‰é’®  -->
      <view :style="{top:statusHeight + 'rpx'}" class="return-icon" v-if="isSearch">
        <uni-icons type="back" size="22" color="white"></uni-icons>
      </view>

<style>
   /* æœç´¢ç•Œé¢å•ç‹¬æ·»åŠ æ ·å¼ */
    .return-icon {
        position: absolute;
        left: 0;
        top: 50%;
        height: 60rpx;
        @include flex(center);
    }
</style>
```

   2. ä¸ºç‚¹å‡»äº‹ä»¶æ·»åŠ æ¡ä»¶å¤„ç†ï¼Œå½“ä¸ºæœç´¢ç•Œé¢æ—¶ï¼Œé˜»æ­¢è·³è½¬äº‹ä»¶

      ```js
      	if (this.isSearch) return
      				uni.navigateTo({
      					url: '/pages/search/search'
      				})
      ```

3. è°ƒæ•´æ ·å¼å¤„ç†ï¼Œæ ¹æ®æ¡ä»¶æ·»åŠ ğŸ”™æŒ‰é’®ï¼Œå¹¶ç»‘å®šè¿”å›äº‹ä»¶

   ```html
      *<!--å½“ç•Œé¢ä¸ºæœç´¢ç•Œé¢çš„æ—¶å€™ï¼Œæ·»åŠ å›é€€æŒ‰é’®  -->*
   
      â€‹      *<*view @click="returnArticleList" :style="{top:statusHeight + 'rpx'}" class="return-icon" v-if="isSearch"*>*
   
      â€‹        *<*uni-icons type="back" size="22" color="white"*></*uni-icons*>*
   
      â€‹      *</*view*>*
   
   
   ```

4. æ·»åŠ å›é€€äº‹ä»¶ï¼Œæ ¹æ®å¹³å°ä½¿ç”¨æŒ‡å®šäº‹ä»¶

   ```js
   	// è¿”å›æ–‡ç« åˆ—è¡¨ç•Œé¢
   			returnArticleList() {
   				// #ifdef H5
   				uni.switchTab({
   					url: '../../pages/index/index'
   				})
   				// #endif
   				// #ifndef H5
   				uni.navigateBack()
   				// #endif
   
   			}
   ```

   

### äºŒã€æœç´¢ç•Œé¢ç»“æ„æ­å»º

> â€‹	æ ¹æ®å½“å‰çŠ¶æ€ï¼Œè¿›è¡Œå†…å®¹æ¡ä»¶æ¸²æŸ“

```html
  <view class="search-container">
    <!-- æœç´¢å¯¼èˆªç»„ä»¶ -->
    <NavBar :isSearch="isSearch"></NavBar>
    <!-- æœç´¢åŒ…è£¹ -->
    <view class="search-wrapper">
      <!-- æ²¡æœ‰è¿›è¡Œæœç´¢çš„æ“ä½œ -->
      <view v-if="false" class="search-history-container">
        <!-- å¤´éƒ¨ -->
        <view class="search-header">
          <text class="history-text">æœç´¢å†å²</text>
          <text class="history-clean">æ¸…ç©º</text>
        </view>
        <!-- å†…å®¹éƒ¨åˆ† -->
        <view class="search-history-content">
          <view class="history-content-item" v-for="item in 10" :key="item">ç›´æ’­</view>
        </view>

        <view class="no-data">å½“å‰æ²¡æœ‰æœç´¢å†å²</view>
      </view>

      <!-- å¼€å§‹è¿›è¡Œæœç´¢çš„æ“ä½œ -->
      <view v-else class="search-list-container">
        <ListItem v-if="searchList.length"></ListItem>
         <view v-else class="no-data">æ²¡æœ‰æœç´¢åˆ°ç›¸å…³æ•°æ®</view>
      </view>
    </view>
  </view>	
```


## æœç´¢ç•Œé¢-ä¸šåŠ¡é€»è¾‘å¤„ç†

### ä¸€ã€è·å–æ–‡æœ¬è¾“å…¥å†…å®¹

â€‹	inputç»„ä»¶å‚è€ƒåœ°å€ï¼š[https://uniapp.dcloud.io/component/input?id=input](https://uniapp.dcloud.io/component/input?id=input)

1. æ·»åŠ å³ä¸‹è§’ç‚¹å‡»æŒ‰é’®äº‹ä»¶

2. è°ƒæ•´å³ä¸‹è§’æ˜¾ç¤ºæ–‡å­—

3. çˆ¶å­ç»„ä»¶å®ç°æ•°æ®åŒå‘ç»‘å®š

   ```js
   // NavVarç»„ä»¶
    computed: {
       // åŠ¨æ€è·å–searchvalueå†…å®¹
       searchVal: {
         get () {
           return this.parentVal
         },
         set (val) {
           this.$emit('updateVal', val)
           if (!val) {
             this.$emit('sendSearchData')
           }
         }
       }
     }
   ```

4. å¤„ç†ç©ºæ•°æ®å†…å®¹ï¼Œæ¸…ç©ºæ“ä½œåè¿”å›ä¸€ä¸ªç©ºçš„searchList

### äºŒã€äº‘å‡½æ•°å®šä¹‰å¹¶è¿”å›æ•°æ®

1. å®šä¹‰äº‘å‡½æ•°

```js
 const list = await db.collection('article')
    .aggregate() // ä½¿ç”¨èšåˆçš„å½¢å¼è¿›è¡Œæ•°æ®çš„è·å–
    // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œæ¨¡ç³ŠåŒ¹é…ï¼Œåªè¦æ˜¯åŒ…å«ï¼Œå°±è¿›è¡Œè¿”å›æ“ä½œ
    .match({ title: new RegExp(searchVal) })
    .project({
      content: 0 // æœ¬æ¬¡æŸ¥è¯¢ä¸éœ€è¦è¿”å›æ–‡ç« è¯¦æƒ…ç»™å‰ç«¯
    })
    .end()
```

2. å‰ç«¯è¿›è¡Œæ•°æ®æ¸²æŸ“å¤„ç†

   ```js
     async _sendSearchData (val) {
         if (!this.parentVal) {
           this.searchList = []
           return
         }
          const { articleList, total } = await this.$http.get_search_data({ searchVal: this.parentVal })
         this.searchList = articleList
         this.total = total
       }
   ```

### ä¸‰ã€å¤„ç†å†å²è®°å½•åˆ‡æ¢æ˜¾ç¤º

1. å®šä¹‰ç°å®çŠ¶æ€æ ‡è¯†

   ```js
   // searchPage
    data() {
      return {
        isShowHistory:true,
         historyList:[],
      }
    }
   ```

2. ç‚¹å‡»å¡ç‰‡ç”Ÿæˆå†å²è®°å½•

   é€šè¿‡è‡ªå®šä¹‰äº‹ä»¶å½¢å¼ä¼ é€’æ•°æ®åˆ°searchç•Œé¢

   ```js
    openHistory(val) {
         this.parentVal = val
         this._sendSearchData()
       }
   ```

3. ç‚¹å‡»å¡ç‰‡å®ç°æœç´¢å†…å®¹ä¿å­˜

   ```js
   // searchPaage  
   openHistory(val) {
         this.parentVal = val
         this._sendSearchData()
       }
   // mutaitions.jså¤„ç†
     // è®¾ç½®å†å²æ”¶è—ä¿¡æ¯
     setHistory (state, val) {
       let list = state.historyList;
       // åˆ¤æ–­æ˜¯å¦åŒ…å«å½“å‰æœç´¢çš„å†…å®¹ï¼ŒåŒ…å«ç›´æ¥ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
       if (list.length > 0 && list.findIndex(item => item === val) > -1) return
       list.unshift(val);
       uni.setStorageSync('historyList', list)
       state.historyList = list;
     },
    // state.jsè¿›è¡Œåˆå§‹å€¼ç»‘å®š
    export default {
     historyList: uni.getStorageSync('historyList') || []
   }
   ```

4. ç‚¹å‡»å†å²è®°å½•æ–‡å­—å®ç°æœç´¢åŠŸèƒ½

   ```js
     // å¼¹å‡ºæœç´¢å†…å®¹
       openHistory(val) {
         this.parentVal = val
         this._sendSearchData()
       },  
   ```

   

5. å®ç°ç‚¹å‡»æ¸…ç©ºæŒ‰é’®å¤„ç†æ¸…ç©ºå†å²è®°å½•æ“ä½œï¼Œé€šè¿‡listCardå‘é€è‡ªå®šä¹‰äº‹ä»¶ï¼ŒsearchPageæ¥æ”¶åˆ°è‡ªå®šä¹‰äº‹ä»¶åï¼Œé€šè¿‡å‡ºå‘mutationé‡Œé¢çš„æŒ‡å®šäº‹ä»¶ï¼Œè¿›è¡Œstateçš„æŒ‡å®šå±æ€§æ¸…ç©ºæ“ä½œ

   ```js
   // mutations.js
     // æ¸…ç©ºæœç´¢å†å²ä¿¡æ¯
     cleanHistory (state) {
       uni.removeStorageSync('historyList')
       state.historyList = []
       uni.showToast({
         title: "æ¸…ç©ºå®Œæˆ",
         icon: "success"
       })
     }
   ```

   

## æ ‡ç­¾é¡µé¢-ç»“æ„æ­å»º

### ä¸€ã€åˆ›å»ºæ ‡ç­¾é¡µé¢ï¼Œå®Œæˆç»“æ„æ ·å¼å¤„ç†

1. åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•ï¼Œæœªç™»å½•ç›´æ¥è·³è½¬ç™»å½•ç•Œé¢

2. æ˜¾ç¤ºç»“æ„åŠæ ·å¼å¤„ç†

   ![image-20210811101547860](https://tva1.sinaimg.cn/large/008i3skNly1gtcmqny743j60mm0eewf602.jpg)

   

3. éšå¼æ ·å¼å¤„ç†

   ![image-20210811101647253](https://tva1.sinaimg.cn/large/008i3skNly1gtcmrn8c2uj60my0li75d02.jpg)

### äºŒã€æ§åˆ¶æ ‡æŒ‰é’®çŠ¶æ€

1. æ·»åŠ çŠ¶æ€å±æ€§ç›‘å¬ï¼Œå®ç°åˆ‡æ¢æŒ‰é’®æ–‡æœ¬åŠæ˜¯å¦è¿›è¡Œæ ‡ç­¾æä¿®æ”¹å‘é€æ“ä½œ

### ä¸‰ã€è°ƒæ•´labelListä¸ºå…¨å±€å…¬å…±çŠ¶æ€

1. storeå®šä¹‰labelListå±æ€§
2. åœ¨articleListç•Œé¢è¿›è¡ŒlabelListå¼•ç”¨æ›¿æ¢
## æ ‡ç­¾é¡µé¢-é€‰é¡¹å¡ä¸šåŠ¡é€»è¾‘å¤„ç†

### ä¸€ã€åˆ›å»ºæˆ‘çš„æ ‡ç­¾åŠæ¨èæ ‡ç­¾æ•°ç»„

1. ä½¿ç”¨è®¡ç®—å±æ€§è¿›è¡Œæ•°ç»„åˆ›å»º

   ```js
   selfLabelList () {
         return this.labelList.filter(item => this.labelIds.includes(item._id))
       },
       recommentLabelList () {
         return this.labelList.filter(item => !this.labelIds.includes(item._id) && item._id)
       },
   ```

2. åˆå§‹åŒ–å®šä¹‰æœ¬åœ°æ•°æ®å¯¹è±¡

   > ä¸ºäº†ä¸å½±å“ç”¨æˆ·æ•°æ®ï¼Œé¡µé¢å†…å®šä¹‰å±æ€§è¿›è¡Œç”¨æˆ·æ•°ç»„ä¿¡æ¯æ•°æ®æ‹·è´,watchä¸­è¿›è¡Œè°ƒç”¨,ä¸ºäº†é˜²æ­¢ç”¨æˆ·åœ¨ä¿®æ”¹ä¹‹åï¼Œè¿›è¡Œç”¨æˆ·çš„æ”¹å˜æ— æ³•è·å–å‡†ç¡®çš„å†…å®¹ï¼Œé€šè¿‡watchä¸­è¿›è¡Œæ‹·è´æ“ä½œï¼Œå¹¶ä½¿ç”¨immediateåˆå§‹è¯è¿›è¡Œwatchä½¿ç”¨

   ```js
     watch: {
       userInfo: {
         immediate: true,
         handler (newVal, oldVal) {
           this.labelIds = [...(this.userInfo.label_ids)]
         }
       }
     },
   ```

3. è¿›è¡Œé¡µé¢æ•°æ®æ¸²æŸ“

   ```html
   // ç”¨æˆ·æ ‡ç­¾ç»„
           <view class="label-content-item" v-for="(item,index) in selfLabelList" :key="index">
             {{item.name}}
             <uni-icons @click="deleteLabelItem(item)" v-if="isEdit" class="icon-close" type="clear" size="20" color="red"></uni-icons>
           </view>
           <view v-if="!selfLabelList.length" class="no-data">å½“å‰æ²¡æœ‰æ•°æ®</view>
         </view>
   
   // æ¨èæ ‡ç­¾ç»„
   <view class="label-content">
           <view class="label-content-item" @click="changeSelfList(item)" v-for="(item,index) in recommentLabelList" :key="index">
             {{item.name}}
           </view>
           <view v-if="!recommentLabelList.length" class="no-data">å½“å‰æ²¡æœ‰æ•°æ®</view>
   </view>
   ```

4. ä¸ºæ ‡ç­¾åˆ‡æ¢æ·»åŠ ç‚¹å‡»äº‹ä»¶

   > æ ‡ç­¾åˆ‡æ¢è¿‡ç¨‹ä¸­éœ€è¦æ³¨æ„ï¼Œåœ¨isEditæƒ…å†µä¸‹åœ¨è¿›è¡Œæ ‡ç­¾åˆ‡æ¢æ“ä½œã€‚ï¼Œè¿½åŠ ç”¨æˆ·æ ‡ç­¾ï¼Œç›´æ¥ä¿®æ”¹labelIds,åˆ é™¤æ ‡ç­¾ï¼Œç›´è¿‡æ»¤åŒ¹é…å†…å®¹ã€‚åœ¨æœªç‚¹å‡»ä¿å­˜æŒ‰é’®çš„æ—¶å€™ï¼Œä¸éœ€è¦è¿›è¡ŒæŒ¯æ­£æ•°æ®å­˜å‚¨

   ```js
    //ä¿®æ”¹å½“å‰ç”¨æˆ·çš„labelList 
       changeSelfList (item) {
         if (!this.isEdit) return
         this.labelIds.push(item._id)
       },
       // åˆ é™¤ç”¨æˆ·é€‰é¡¹å†…å®¹
       deleteLabelItem (item) {
         this.labelIds = this.labelIds.filter(val => val !== item._id)
       }
   ```

### äºŒã€æ•°æ®å‘é€

1. å‰ç«¯æ”¶é›†æ•°æ®ï¼Œå½“å‰ç”¨æˆ·IDï¼ŒåŠç°é˜¶æ®µæ”¶è—çš„æ•°ç»„ selfIds

   ```js
    const label_ids = this.selfLabelList.map(item => item._id)
         const res = await this.$http.update_label_ids({ userId: this.userInfo._id, label_ids });
        
   ```

2. åˆ›å»ºäº‘å‡½æ•°ã€‚ä¿®æ”¹æ•°æ®åº“ä¸­ç”¨æˆ·label_idså­—æ®µ

   ```js
   'use strict';
   const db = uniCloud.database()
   exports.main = async (event, context) => {
   	//eventä¸ºå®¢æˆ·ç«¯ä¸Šä¼ çš„å‚æ•°
   	const {userId,label_ids} = event
   	
   	const res = await  db.collection('user').doc(userId).update({
   		label_ids
   	})
   	//è¿”å›æ•°æ®ç»™å®¢æˆ·ç«¯
   	return {
   		code:0,
   		data:{
   			msg:"ä¿®æ”¹æˆåŠŸ"
   		}
   	}
   };
   ```

3. å‰ç«¯æ¥æ”¶è¿”å›å€¼ï¼Œé‡æ–°è°ƒæ•´userInfoå³å¯ã€‚

   ```js
    uni.showToast({
           title: res.msg
         })
         this.updateUserInfo({ ...this.userInfo, label_ids });
   ```

### ä¸‰ã€å¤„ç†å…¶ä»–ç•Œé¢å‰¯ä½œç”¨

1. â€‹	è°ƒæ•´indexç•Œé¢labelListè·å–æ–¹å¼,åˆ¤æ–­æ˜¯å¦åŒ…å«ç”¨æˆ·ä¿¡æ¯ï¼Œä¸åŒ…å«ç›´æ¥è¿”å›ï¼Œå¦åˆ™ï¼Œæ˜¾ç¤ºç”¨æˆ·æœè—å†…å®¹

   ```js
   computed: {
       labelList () {
         if (this.userInfo) {
           this.activeIndex = 0;
           return [...this.$store.state.labelList.slice(0,1),...this.$store.state.labelList.filter(item => this.userInfo.label_ids.includes(item._id))]
         } else {
           return this.$store.state.labelList
         }
       },
   ```

2. articleé¡µé¢å†…éƒ¨å…¼å¬åˆ°userListæ”¹å˜å€¼åï¼Œæ¸…ç©ºåˆ—è¡¨å¯¹è±¡

   ```js
     watch: {
       labelList (newVal, OldVal) {
         this.articleData = {}
         this.loadData = {}
         this._getArticleList(this.activeIndex)
       },
     },
   ```

   


## æ–‡ç« è¯¦æƒ…é¡µé¢-ç»“æ„æ ·å¼å¤„ç†



**demo**

<img src="https://tva1.sinaimg.cn/large/008i3skNly1gtduwl12kkj60lu11sq4702.jpg" alt="image-20210812114350053" style="zoom:50%;" />

### ä¸€ã€åŸºæœ¬ç»“æ„

â€‹		

```html
<template>
	<view class="article-detail-container">
		<view class="detail-title">
			ssråŸºæœ¬ä»‹ç»ä»¥åŠAPIçš„ä½¿ç”¨
		</view>
		<view class="detail-header">
			<view class="detail-logo">
				<image src="../../static/img/logo.jpeg" mode="aspectFill"></image>
			</view>
			<view class="detail-header-content">
				<view class="detail-header-content-title">
					WEBè®²å¸ˆ
				</view>
				<view class="detail-header-content-info">
					<text>2020.03.16 17:50</text>
					<text>173 æµè§ˆ</text>
					<text>6 èµ</text>
				</view>
			</view>
			<button type="default" class="detail-header-button">å–æ¶ˆå…³æ³¨</button>
		</view>
		<view class="detail-content-container">
			<view class="detail-html">
				æ–‡æœ¬å†…å®¹
			</view>
		</view>

		<!-- è¯„è®ºç»„ä»¶ -->
		<view class="detail-bottom">
			<view class="input-container">
				<text>è°ˆè°ˆä½ çš„çœ‹æ³•</text>
				<uni-icons type="compose" size="16" color="#f07373"></uni-icons>
			</view>
			<view class="detail-bottom-icons">
				<view class="detail-bottom-icon-box">
					<uni-icons type="chat" size="22" color="#f07373"></uni-icons>
				</view>
				<view class="detail-bottom-icon-box">
					<uni-icons type="heart" size="22" color="#f07373"></uni-icons>
				</view>
				<view class="detail-bottom-icon-box">
					<uni-icons type="hand-thumbsup" size="22" color="#f07373"></uni-icons>
				</view>
			</view>
		</view>
	</view>
</template>
```



### äºŒã€åˆå§‹åŒ–æ ·å¼

â€‹	

```css
.article-detail-container {
	padding: 30rpx 0 108rpx;
}

.detail-title {
	padding: 0 30rpx;
	font-size: 36rpx;
	font-weight: bold;
}

.detail-header {
	@include flex(flex-start);
	margin-top:20rpx;
	padding: 0 30rpx;
	.detail-logo {
		flex-shrink: 0;
		width: 80rpx;
		height: 80rpx;
		border-radius: 50%;
		overflow: hidden;
		image {
			width: 100%;
			height: 100%;
		}
	}
	.detail-header-content {
		width: 100%;
		padding-left: 20rpx;
		@include flex(space-between,column);
		font-size: 24rpx;
		align-items: flex-start;
		.detail-header-content-title {
			font-size: 28rpx;
			color: #333;
		}
		.detail-header-content-info {
			color: $c-9;
			text {
				margin-right: 20rpx;
			}
		}
	}
	.detail-header-button {
		padding: 0 30rpx;
		flex-shrink: 0;
		height: 60rpx;
		line-height: 60rpx;
		border-radius: 10rpx;
		font-size: 24rpx;
		color: #FFFFFF;
		background-color: $base-color;
	}
}

.detail-content-container {
	margin-top: 40rpx;
	// min-height: 1000rpx;
	.detail-html {
		padding: 0 30rpx;
	}
}

.detail-bottom {
	position: fixed;
	bottom: 0;
	left: 0;
	@include flex(flex-start);
	width: 100%;
	height: 88rpx;
	border-top: 1px #f5f5f5 solid;
	background-color: #FFFFFF;
	box-sizing: border-box;
	.input-container {
		@include flex();
		margin-left: 20rpx;
		padding: 0 20rpx;
		flex-grow: 1;
		height: 60rpx;
		border: 1px solid #ddd;
		border-radius: 5px;
		text {
			font-size: 28rpx;
			color: $c-9;
		}
	}
	.detail-bottom-icons {
		display: flex;
		flex-shrink: 0;
		padding: 0 20rpx;
	}
	.detail-bottom-icon-box {
		position: relative;
		@include flex(center);
		width: 88rpx;
	}
}
```

## æ–‡ç« è¯¦æƒ…é¡µé¢-æ•°æ®åˆå§‹åŒ–æ¸²æŸ“



### ä¸€ã€URLå‚æ•°å¤„ç†

> â€‹	åœ¨listcardç»„ä»¶è·³è½¬è¿‡ç¨‹ä¸­æºå¸¦å‚æ•°åˆ°è¯¦æƒ…ç•Œé¢å®ç°æ•°æ®ä¸æ¸²æŸ“

â€‹		**å¡ç‰‡ç»„ä»¶**

```js
  /* æ·»åŠ å‚æ•°ä¼ é€’ */
      const { _id, title, author, create_time, thunbs_up_count, browse_count } = this.item
      const params = { _id, title, author, create_time, thunbs_up_count, browse_count };
      uni.navigateTo({url: `../../pages/articleDetail/articleDetail?params=${JSON.stringify(params)}`})
```

â€‹        **æ–‡ç« è¯¦æƒ…ç•Œé¢**

```js
onLoad (...options) {
    this.articleData = JSON.parse(options[0].params)
  },
```

â€‹		**è·å–æ•°æ®åè¿›è¡ŒUIç•Œé¢æ¸²æŸ“**

### äºŒã€è¿›è¡Œæ•°æ®è¯·æ±‚å‘é€

1. å‰ç«¯æºå¸¦å½“å‰æ–‡ç« IDè¿›è¡Œå‚æ•°ä¼ é€’

2. å®šä¹‰äº‘å‡½æ•°

   ```js
   'use strict';
   const db = uniCloud.database();
   exports.main = async (event, context) => {
     const { article_id } = event;
   
     const articleList = await db.collection('article')
       .aggregate()
       .match({
         _id: article_id
       })
       .end();
   
   
   
     //è¿”å›æ•°æ®ç»™å®¢æˆ·ç«¯
     return {
       code: 0,
       msg: "æ–‡ç« è·å–æˆåŠŸ",
       data: articleList.data[0]
     }
   };
   ```

3. è·å–æ•°æ®åæ›´æ–°articleDataæ•°æ®

   1. è§£æå†…å®¹æ•°æ®ä½¿ç”¨ä¸‰æ–¹æ’ä»¶uParse 

   2. ä¸‹è½½åœ°å€ï¼š[https://ext.dcloud.net.cn/plugin?id=364](https://ext.dcloud.net.cn/plugin?id=364)

   3. è§£æmarkdownæ–‡æœ¬ä½¿ç”¨ä¸‰æ–¹æ’ä»¶marked

      ä¸‹è½½ï¼šnpm install markdown | yarn markdown 

      ä½¿ç”¨ï¼š

      

      ```js
       content () {
            try {
              return marked(this.articleData.content)
            } catch (e) {
              return null
            }
          }
      ```

      











â€‹	



## æ–‡ç« è¯¦æƒ…é¡µé¢-è¯„è®ºç»„ä»¶åˆ¶ä½œ



> å½“ç”¨æˆ·ä¸ºæœªç™»å½•çŠ¶æ€ï¼Œå…ˆè¿›è¡Œç™»å½•ç•Œé¢è·³è½¬æ“ä½œ

### ä¸€ã€æ·»åŠ ä¸‰æ–¹æ’ä»¶

1. æ’ä»¶å¸‚åœºå†…ä¸‹è½½æ’ä»¶uni-popup ä¸‹è½½åœ°å€ï¼š[https://ext.dcloud.net.cn/plugin?id=329](https://ext.dcloud.net.cn/plugin?id=329)

2. å®šä¹‰å¼¹å‡ºå±‚ç»„ä»¶CommentMaskerï¼Œä¼ é€’æ˜¯å¦æ‰“å¼€å¼¹çª—æ ‡è¯†

   ```html
    <CommentMasker  :showPopup="showPopup"></CommentMasker>
   ```

3. å®Œæˆå†…å®¹åŒºåŸŸç»“æ„æ ·å¼åˆ›å»º

   ```css
   <style lang="scss">
   .popup-wrapper {
     background-color: #ffffff;
     .popup-header {
       @include flex();
       font-size: 28rpx;
       color: #666;
       border-bottom: 1px #f5f5f5 solid;
       .popup-header-item {
         height: 100rpx;
         line-height: 100rpx;
         padding: 0 30rpx;
       }
     }
     .popup-content {
       width: 100%;
       padding: 30rpx;
       box-sizing: border-box;
       .popup-content-textarea {
         height: 400rpx;
         width: 100%;
       }
       .popup-content-count {
         @include flex(flex-end);
         font-size: 24rpx;
         color: $c-9;
       }
     }
   }
   </style>
   ```

äºŒã€äº‘å‡½æ•°è¿›è¡Œè¯„è®ºå†…å®¹ä¿å­˜

1. å‰ç«¯è¿›è¡Œæ•°æ®æ”¶é›†,è·å–ç”¨æˆ·idï¼Œæ–‡ç« idï¼Œè¯„è®ºå†…å®¹

2. åˆ›å»ºäº‘å‡½æ•°,ä¸ºarticleè¿›è¡Œè¯„è®ºå†…å®¹è¿½åŠ 

   ```
     let commentObj = {
       comment_id: generatedId(5),
       comment_content: content,
       create_time: Date.now(),
       is_reply: false,
       author: {
         author_id: user._id,
         author_name: user.author_name,
         avatar: user.avatar,
         professional: user.professional
       },
       replyArr: []
     }
   
     commentObj = dbCmd.unshift({ commentObj })
     await db.collection('article').doc(articleId).update({
       comments: commentObj
     })
   ```

   â€‹		ä¸ºcomment_idæŒ‡å®šéšæœºidå€¼

   ```js
   function generatedId (num) {
       return Number(Math.random().toString().substr(3, num) + Date.now()).toString(36)
     }
   ```

3. è¿”å›æ•°æ®åˆ°å‰ç«¯ï¼Œå‰ç«¯è¿›è¡Œå¼¹çª—å…³é—­æ“ä½œ

   ```js
      async _sendCommentData (content) {
         const {msg} = await this.$http.update_comment({ articleId: this.articleData._id, userId: this.userInfo._id ,content})
         uni.showToast({
           title:msg,
         })
         this.showPopup = false;
       }
   ```

   

## æ–‡ç« è¯¦æƒ…é¡µé¢-è¯„è®ºå±•ç¤ºç»„ä»¶åˆ¶ä½œ



### ä¸€ã€ç•Œé¢ç»“æ„æ­å»º

> ä¸‹è½½æ—¥æœŸæ ¼å¼åŒ–ç»„ä»¶ï¼Œä¸‹è½½åœ°å€ï¼š[https://ext.dcloud.net.cn/plugin?id=3279](https://ext.dcloud.net.cn/plugin?id=3279)

### äºŒã€å®šä¹‰äº‘å‡½æ•°ï¼Œè¿›è¡Œå†…å®¹è·å–

1. å‰ç«¯è¿›è¡Œäº‘å‡½æ•°è¯·æ±‚

   ```js
    async _getCommentList () {
         const res = await this.$http.get_comments({ articleId: this.formData._id })
       }
   ```

2. å®šä¹‰äº‘å‡½æ•° get_comments 

   ```js
   'use strict';
   const db = uniCloud.database();
   exports.main = async (event, context) => {
     const {
       articleId,
       pageSize = 10,
       page = 1
     } = event;
   
     const list = await db.collection('article')
       .aggregate()
       .match({
         _id: articleId,
       })
       .unwind('$comments') // ä»æŒ‡å®šçš„èŠ‚ç‚¹è¿›è¡Œå†…å®¹çš„è·å–
       .project({
         _id: 0,
         comments: 1
       })
       .replaceRoot({
         newRoot: '$comments'
       })
       .skip(pageSize * (page - 1))
       .limit(pageSize)
       .end()
   
     //è¿”å›æ•°æ®ç»™å®¢æˆ·ç«¯
     return {
       code: 0,
       msg: 'æ•°æ®è¯·æ±‚æˆåŠŸ',
       data: list.data
     }
   };
   
   ```

3. å‰ç«¯è¿›è¡Œå†…å®¹æ¸²æŸ“

   ```js
    <view class="comment-box">
       <view class="comment-header">
         <view class="comment-header-logo">
           <image :src="commentData.author.avatar" mode="aspectFill"></image>
         </view>
         <view class="comment-header-info">
           <view class="title">
             {{commentData.author.author_name}}
           </view>
           <view class="">
             <uni-dateformat :date="commentData.create_time" format="yyyy-MM-dd hh:mm:ss"></uni-dateformat>
           </view>
         </view>
       </view>
       <!-- å†…å®¹éƒ¨åˆ† -->
       <view class="comment-content">
         <view class="">
           {{commentData.comment_content}}
         </view>
         <view class="comment-info">
           <view class="comment-button">
             å›å¤
           </view>
         </view>
       </view>
     </view>
   ```

   
## æ–‡ç« è¯¦æƒ…é¡µé¢-æŒ‡å®šè¯„è®ºå†…å®¹å¤„ç†



### ä¸€ã€æŒ‡å®šè¯„è®ºå›å¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶ç»‘å®š

1. æ·»åŠ comment_idä¼ é€’ç»™äº‘å‡½æ•°ï¼Œä¿è¯äº‘å‡½æ•°çŸ¥é“å½“å‰æ˜¯é’ˆå¯¹é‚£æ¡è¯„è®ºè¿›è¡Œçš„å›å¤

### äºŒã€äº‘å‡½æ•°è°ƒæ•´

1. â€‹	ä»å½“å‰çš„commnetsé›†åˆå½“ä¸­é€šè¿‡ä¼ é€’çš„comment_idè·å–æŒ‡å®šçš„é‚£ä¸€æ¡è®°å½•å€¼

2. ä¸ºå½“å‰çš„è®°å½•å€¼çš„replyArrå±æ€§æ’å…¥ä¸€ä¸ªæ–°çš„è¯„è®ºå†…å®¹

   ```js
   // è·å–æŒ‡å®šçš„è¯„è®ºå†…å®¹
   let commentIndex = comments.findIndex(item => item.comment_id === comment_id)
   ```

3. ä¿®æ”¹æŒ‡å®šå‘¢ç´¢å¼•å€¼çš„æ•°æ®çš„replyArrçš„è®°å½•å€¼

   ```js
   commentObj = {
   			[commentIndex]: {
   				replyArr: dbCmd.unshift(commentObj)
   			}
   		}
   ```

### ä¸‰ã€å‰ç«¯è¿›è¡Œæ•°æ®æ¸²æŸ“

> â€‹	ä½¿ç”¨ç»„ä»¶è‡ªè°ƒç”¨çš„å½¢å¼è¿›è¡Œæ•°æ®æ¸²æŸ“

1. â€‹	åœ¨è‡ªè°ƒç”¨çš„è¿‡ç¨‹å½“ä¸­éœ€è¦æ³¨æ„ï¼Œä¿è¯è°ƒç”¨æ—¶è¿›è¡ŒæŒ‡å®šnameå±æ€§å€¼ï¼Œ

   ![image-20210816181929682](https://tva1.sinaimg.cn/large/008i3skNly1gtistfyfh7j614e09m0tw02.jpg)

2. ä½¿ç”¨è‡ªè°ƒç”¨çš„è¿‡ç¨‹ä¸­ä¼šæœ‰ä¸¤æ¬¡çˆ¶ç»„å»ºäº‹ä»¶å‘é€çš„è¿‡ç¨‹ï¼Œä¸€æ¬¡æ˜¯å½“å‰ç»„ä»¶ä½œä¸ºçˆ¶ç»„ä»¶çš„æ—¶å€™è·å–åˆ°å‘é€çš„äº‹ä»¶ï¼Œå¦ä¸€æ¬¡æ˜¯å‘ä¸Šçº§articleDetailä¼ é€’çš„æ—¶å€™æ¥æ”¶åˆ°çš„äº‹ä»¶ã€‚

3. å½“æŒ‡å®šå›å¤è¿›è¡Œäº‹ä»¶å‘é€çš„æ—¶å€™ï¼Œéœ€è¦æŒ‡å®šreply_id,å¹¶ä¸”è°ƒæ•´comment_idå€¼ï¼›

   ![image-20210816182213715](https://tva1.sinaimg.cn/large/008i3skNly1gtiswajjujj610s0aidhn02.jpg)

4. æ¸²æŸ“å®Œæˆä¹‹åï¼Œå°†replayDataè¿›è¡Œæ¸…ç©ºå¤„ç†
## æ–‡ç« è¯¦æƒ…é¡µé¢-å…³æ³¨ä½œè€…



### ä¸€ã€UIæ˜¾ç¤ºå¤„ç†

> åˆ¤æ–­å½“å‰çš„ç™»å½•ç”¨æˆ·æ˜¯å¦åŒ…å«æ–‡ç« ä½œè€…çš„ç”¨æˆ·ID

```js
// æ·»åŠ è®¡ç®—å±æ€§ 
isFollowAuthor() {
      return this.userInfo && this.userInfo.author_likes_ids.includes(this.articleData.author.id)
    }
```

### äºŒã€äº‹ä»¶ç»‘å®š

> â€‹	ä¼ é€’æ–‡ç« ä½œè€…IDï¼ŒåŠå½“å‰ç™»å½•ç”¨æˆ·ID

```js
const { msg } = await this.$http.update_follow_author({ authorId: this.articleData.author.id, userId: this.userInfo._id })

```

### ä¸‰ã€äº‘å‡½æ•°å®šä¹‰

```js
'use strict';
const db = uniCloud.database();
const dbCmd = db.command;
exports.main = async (event, context) => {
  const {
    userId,
    authorId
  } = event;

  const user = await db.collection('user').doc(userId).get();
  const authorLikesIds = user.data[0].author_likes_ids
  let returnMsg = ''

  let author_ids = null
  if (authorLikesIds.includes(authorId)) {
    returnMsg = 'å–æ¶ˆå…³æ³¨æˆåŠŸ'
    author_ids = dbCmd.pull(authorId)
  } else {
    returnMsg = 'å…³æ³¨ä½œè€…æˆåŠŸ'
    author_ids = dbCmd.addToSet(authorId)
  }

  // å°†å¤„ç†å®Œçš„å†…å®¹è¿›è¡Œé‡æ–°æ’å…¥
  await db.collection('user').doc(userId).update({
    author_likes_ids: author_ids
  })

  //è¿”å›æ•°æ®ç»™å®¢æˆ·ç«¯
  return {
    code: 0,
    data: {
      msg: returnMsg
    }
  }
};

```

### å››ã€å‰ç«¯å¤„ç†ç”¨æˆ·ä¿å­˜ä¿¡æ¯

```js
 async _followAuthor () {
      // ç”¨æˆ·æ£€æµ‹
      await this.checkedIsLogin()
      const { msg } = await this.$http.update_follow_author({ authorId: this.articleData.author.id, userId: this.userInfo._id })
      uni.showToast({
        title: msg,
      })
      //å¤„ç†ç”¨æˆ·å­˜å‚¨ä¿¡æ¯
      let followIds = [...this.userInfo.author_likes_ids]
      if (followIds.includes(this.articleData.author.id)) {
        followIds = followIds.filter(item => item != this.articleData.author.id)
      }else {
        followIds.push(this.articleData.author.id)
      }
      this.updateUserInfo({...this.userInfo,author_likes_ids:followIds})
    }
```

### äº”ã€æ”¶è—æ–‡ç« å¤„ç†

1. ä½¿ç”¨å…¬å…±ç»„ä»¶ SaveLikes

```js
  <SaveLikes size="22" class="detail-bottom-icon-box" :item="articleData"></SaveLikes>
```

2. å¤„ç†æ¯æ¬¡è¯·æ±‚éƒ½è¿›è¡Œæ–‡ç« åˆ—è¡¨åŠ è½½Bug

   ![image-20210817000518736](https://tva1.sinaimg.cn/large/008i3skNly1gtj2t9k9glj31480betag.jpg)

   
## æ–‡ç« è¯¦æƒ…é¡µé¢-ç‚¹èµ+æµè§ˆæ¬¡æ•°å®ç°



### ä¸€ã€æµè§ˆæ¬¡æ•°æ“ä½œ

> è¯·æ±‚æ–‡ç« è¯¦æƒ…çš„äº‘å‡½æ•°è¿”å›å‰ç«¯ä¹‹å‰è¿›è¡Œ+1æ“ä½œ

â€‹		

```js
  // æ¯æ¬¡è¯·æ±‚è¿›è¡Œ+1æ“ä½œ
  await db.collection('article').update({
	  browse_count:dbCmd.inc(1)
  })
```

### äºŒã€æ–‡ç« ç‚¹èµUIå¤„ç†

> â€‹	ä½¿ç”¨è®¡ç®—å±æ€§è¿›è¡ŒUiæ˜¾ç¤º

```js
  isCompliments () {
      try {
        return this.userInfo && this.userInfo.thumbs_up_article_ids.includes(this.articleData._id)
      } catch (e) {
        return false
      }
    }

```

### ä¸‰ã€äº‘å‡½æ•°å®šä¹‰

```js
'use strict';
const db = uniCloud.database()
const dbCmd = db.command  // ä½¿ç”¨æ“ä½œç¬¦
exports.main = async (event, context) => {
  const { articleId, userId } = event;

  const userList = await db.collection('user').doc(userId).get();
  const thumbs_up_article_ids = userList.data[0].thumbs_up_article_ids
  let tempArr = null;
  let returnMsg = '';
  let thumbsNumber = null;


  //todo åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰ç‚¹èµæ“ä½œ
  if (thumbs_up_article_ids.includes(articleId)) {
    tempArr = dbCmd.pull(articleId)
    thumbsNumber = -1
    returnMsg = 'æ‚¨å–æ¶ˆäº†ç‚¹èµ'
  } else {
    tempArr = dbCmd.addToSet(articleId)
    thumbsNumber = 1
    returnMsg = 'ç‚¹èµæˆåŠŸ'
  }

  // å¤„ç†ç”¨æˆ·å­—æ®µ
  await await db.collection('user').doc(userId).update({
    thumbs_up_article_ids: tempArr
  })

  // å¤„ç†æ–‡ç« æ•°é‡å­—æ®µ
  await await db.collection('article').doc(articleId).update({
    thumbs_up_count: dbCmd.inc(thumbsNumber)
  })


  //è¿”å›æ•°æ®ç»™å®¢æˆ·ç«¯
  return {
    code: 0,
    data: {
      msg: returnMsg
    }
  }
};

```

### å››ã€å‰ç«¯å¤„ç†ç”¨æˆ·ä¿å­˜ä¿¡æ¯

```js
 // ç”¨æˆ·æ£€æµ‹
      await this.checkedIsLogin()
      
      const { msg } = await this.$http.update_compliments({ articleId: this.articleData._id, userId: this.userInfo._id })
      msg && uni.showToast({
        title: msg,
      })
      // ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯
      let thumbsArr = [...this.userInfo.thumbs_up_article_ids]
      if (thumbsArr.includes(this.articleData._id)) {
        this.articleData.thumbs_up_count -= 1
        thumbsArr = thumbsArr.filter(item => item != this.articleData._id)
      } else {
        this.articleData.thumbs_up_count += 1
        thumbsArr.push(this.articleData._id)
      }
      this.updateUserInfo({ ...this.userInfo, thumbs_up_article_ids: thumbsArr })
```



è¯„è®ºé¡µé¢åˆ¶ä½œ



### ä¸€ã€é¡µé¢æ³¨å†Œ

1. åˆ›å»ºé¡µé¢
2. page.jsonä¸­è¿›è¡Œé¡µé¢æ³¨å†Œ		
3. è·³è½¬é¡µé¢æ—¶æºå¸¦æŒ‡å®šçš„æ–‡ç« ID

### äºŒã€ç»“æ„æ ·å¼ç¼–å†™

1. ä½¿ç”¨è¯„è®ºç»„ä»¶

   ```js
    <view class="comment-content-container" v-for="item in commentList" :key="item.comment_id">
         <CommentBox @commnetReply="commnetReply" :commentData="item"></CommentBox>
       </view>
   ```

   2. ä½¿ç”¨uni-load-moreç»„ä»¶ï¼Œå¯¹ç»„ä»¶å†…éƒ¨åˆå§‹åŒ–å±æ€§è¿›è¡Œè°ƒæ•´æ“ä½œ

      ```js
       <uni-load-more v-if="commentList.length===0 || commentList.length > 5" :status="loading" :contentText="{	contentdown: 'ä¸Šæ‹‰æ˜¾ç¤ºæ›´å¤š',
      						contentrefresh: 'æ­£åœ¨åŠ è½½...',
      						contentnomore: 'æ²¡æœ‰æ›´å¤šè¯„è®ºäº†'}"></uni-load-more>
      ```

   3. æ ¹æ®æ¡ä»¶è¿›è¡Œè¯„è®ºåˆ—è¡¨çš„è¿½åŠ æ“ä½œ

      ```js
       async _getCommentList () {
            const list = await this.$http.get_comments({
              articleId: this.articleId,
              page: this.page,
              pageSize: this.pageSize,
            })
            if (list.length === 0) {
              this.loading = 'noMore'
              return
            }
            let oldList = JSON.parse(JSON.stringify(this.commentList))
            oldList.push(...list)
            this.commentList = oldList
          },
      ```

### ä¸‰ã€æ·»åŠ è¯„è®ºå†…å®¹è¾“å…¥ç»„ä»¶

```js
 <!-- è¯„è®ºå†…å®¹è¾“å…¥ç»„ä»¶ -->
    <CommentMasker :showPopup="showPopup" @closePopupMasker="showPopup=$event" @sendCommentData="_sendCommentData">
    </CommentMasker>
```

### å››ã€å¤„ç†è¯„è®ºå‘å¸ƒä¸šåŠ¡

1. å›å¤äº‹ä»¶å‡½æ•°å¤„ç†

   ```js
     /* å¤„ç†å›å¤äº‹ä»¶å‡½æ•° */
       commnetReply (data) {
         this.replyData = {
           "comment_id": data.comment.comment_id,
           is_reply: data.isReply
         }
         // å½“å‰ä¸ºå›å¤å†…å®¹çš„æ—¶å€™æ·»åŠ å›å¤çš„ID
         data.comment.reply_id && (this.replyData.reply_id = data.comment.reply_id)
         this.openMaskerComment()
       },
   ```

2. å‰¯ä½œç”¨äº‹åŠ¡å¤„ç†

   ```js
       async _sendCommentData (content) {
         const {
           msg
         } = await this.$http.update_comment({
           userId: this.userInfo._id,
           articleId: this.articleId,
           content,
           ...this.replyData   // æ‰©å±•å½“å‰æ˜¯å¦ä¸ºå›å¤æŒ‡å®šè¯„è®ºå†…å®¹
         })
         uni.showToast({
           title: msg
         })
         // å¤„ç†å‰¯ä½œç”¨äº‹ç‰©
         this.showPopup = false;
         this.replyData = {};
         this.page = 1;
         this.commentList = [];
         this._getCommentList();
       }
   ```

   



## æ–‡ç« è¯¦æƒ…é¡µé¢-å…³æ³¨ä½œè€…



### ä¸€ã€UIæ˜¾ç¤ºå¤„ç†

> åˆ¤æ–­å½“å‰çš„ç™»å½•ç”¨æˆ·æ˜¯å¦åŒ…å«æ–‡ç« ä½œè€…çš„ç”¨æˆ·ID

```js
// æ·»åŠ è®¡ç®—å±æ€§ 
isFollowAuthor() {
      return this.userInfo && this.userInfo.author_likes_ids.includes(this.articleData.author.id)
    }
```

### äºŒã€äº‹ä»¶ç»‘å®š

> â€‹	ä¼ é€’æ–‡ç« ä½œè€…IDï¼ŒåŠå½“å‰ç™»å½•ç”¨æˆ·ID

```js
const { msg } = await this.$http.update_follow_author({ authorId: this.articleData.author.id, userId: this.userInfo._id })

```

### ä¸‰ã€äº‘å‡½æ•°å®šä¹‰

```js
'use strict';
const db = uniCloud.database();
const dbCmd = db.command;
exports.main = async (event, context) => {
  const {
    userId,
    authorId
  } = event;

  const user = await db.collection('user').doc(userId).get();
  const authorLikesIds = user.data[0].author_likes_ids
  let returnMsg = ''

  let author_ids = null
  if (authorLikesIds.includes(authorId)) {
    returnMsg = 'å–æ¶ˆå…³æ³¨æˆåŠŸ'
    author_ids = dbCmd.pull(authorId)
  } else {
    returnMsg = 'å…³æ³¨ä½œè€…æˆåŠŸ'
    author_ids = dbCmd.addToSet(authorId)
  }

  // å°†å¤„ç†å®Œçš„å†…å®¹è¿›è¡Œé‡æ–°æ’å…¥
  await db.collection('user').doc(userId).update({
    author_likes_ids: author_ids
  })

  //è¿”å›æ•°æ®ç»™å®¢æˆ·ç«¯
  return {
    code: 0,
    data: {
      msg: returnMsg
    }
  }
};

```

### å››ã€å‰ç«¯å¤„ç†ç”¨æˆ·ä¿å­˜ä¿¡æ¯

```js
 async _followAuthor () {
      // ç”¨æˆ·æ£€æµ‹
      await this.checkedIsLogin()
      const { msg } = await this.$http.update_follow_author({ authorId: this.articleData.author.id, userId: this.userInfo._id })
      uni.showToast({
        title: msg,
      })
      //å¤„ç†ç”¨æˆ·å­˜å‚¨ä¿¡æ¯
      let followIds = [...this.userInfo.author_likes_ids]
      if (followIds.includes(this.articleData.author.id)) {
        followIds = followIds.filter(item => item != this.articleData.author.id)
      }else {
        followIds.push(this.articleData.author.id)
      }
      this.updateUserInfo({...this.userInfo,author_likes_ids:followIds})
    }
```

### äº”ã€æ”¶è—æ–‡ç« å¤„ç†

1. ä½¿ç”¨å…¬å…±ç»„ä»¶ SaveLikes

```js
  <SaveLikes size="22" class="detail-bottom-icon-box" :item="articleData"></SaveLikes>
```

2. å¤„ç†æ¯æ¬¡è¯·æ±‚éƒ½è¿›è¡Œæ–‡ç« åˆ—è¡¨åŠ è½½Bug

   ![image-20210817000518736](https://tva1.sinaimg.cn/large/008i3skNly1gtj2t9k9glj31480betag.jpg)

   
## æ–‡ç« è¯¦æƒ…é¡µé¢-ç‚¹èµ+æµè§ˆæ¬¡æ•°å®ç°



### ä¸€ã€æµè§ˆæ¬¡æ•°æ“ä½œ

> è¯·æ±‚æ–‡ç« è¯¦æƒ…çš„äº‘å‡½æ•°è¿”å›å‰ç«¯ä¹‹å‰è¿›è¡Œ+1æ“ä½œ

â€‹		

```js
  // æ¯æ¬¡è¯·æ±‚è¿›è¡Œ+1æ“ä½œ
  await db.collection('article').update({
	  browse_count:dbCmd.inc(1)
  })
```

### äºŒã€æ–‡ç« ç‚¹èµUIå¤„ç†

> â€‹	ä½¿ç”¨è®¡ç®—å±æ€§è¿›è¡ŒUiæ˜¾ç¤º

```js
  isCompliments () {
      try {
        return this.userInfo && this.userInfo.thumbs_up_article_ids.includes(this.articleData._id)
      } catch (e) {
        return false
      }
    }

```

### ä¸‰ã€äº‘å‡½æ•°å®šä¹‰

```js
'use strict';
const db = uniCloud.database()
const dbCmd = db.command  // ä½¿ç”¨æ“ä½œç¬¦
exports.main = async (event, context) => {
  const { articleId, userId } = event;

  const userList = await db.collection('user').doc(userId).get();
  const thumbs_up_article_ids = userList.data[0].thumbs_up_article_ids
  let tempArr = null;
  let returnMsg = '';
  let thumbsNumber = null;


  //todo åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰ç‚¹èµæ“ä½œ
  if (thumbs_up_article_ids.includes(articleId)) {
    tempArr = dbCmd.pull(articleId)
    thumbsNumber = -1
    returnMsg = 'æ‚¨å–æ¶ˆäº†ç‚¹èµ'
  } else {
    tempArr = dbCmd.addToSet(articleId)
    thumbsNumber = 1
    returnMsg = 'ç‚¹èµæˆåŠŸ'
  }

  // å¤„ç†ç”¨æˆ·å­—æ®µ
  await await db.collection('user').doc(userId).update({
    thumbs_up_article_ids: tempArr
  })

  // å¤„ç†æ–‡ç« æ•°é‡å­—æ®µ
  await await db.collection('article').doc(articleId).update({
    thumbs_up_count: dbCmd.inc(thumbsNumber)
  })


  //è¿”å›æ•°æ®ç»™å®¢æˆ·ç«¯
  return {
    code: 0,
    data: {
      msg: returnMsg
    }
  }
};

```

### å››ã€å‰ç«¯å¤„ç†ç”¨æˆ·ä¿å­˜ä¿¡æ¯

```js
 // ç”¨æˆ·æ£€æµ‹
      await this.checkedIsLogin()
      
      const { msg } = await this.$http.update_compliments({ articleId: this.articleData._id, userId: this.userInfo._id })
      msg && uni.showToast({
        title: msg,
      })
      // ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯
      let thumbsArr = [...this.userInfo.thumbs_up_article_ids]
      if (thumbsArr.includes(this.articleData._id)) {
        this.articleData.thumbs_up_count -= 1
        thumbsArr = thumbsArr.filter(item => item != this.articleData._id)
      } else {
        this.articleData.thumbs_up_count += 1
        thumbsArr.push(this.articleData._id)
      }
      this.updateUserInfo({ ...this.userInfo, thumbs_up_article_ids: thumbsArr })
```



è¯„è®ºé¡µé¢åˆ¶ä½œ



### ä¸€ã€é¡µé¢æ³¨å†Œ

1. åˆ›å»ºé¡µé¢
2. page.jsonä¸­è¿›è¡Œé¡µé¢æ³¨å†Œ		
3. è·³è½¬é¡µé¢æ—¶æºå¸¦æŒ‡å®šçš„æ–‡ç« ID

### äºŒã€ç»“æ„æ ·å¼ç¼–å†™

1. ä½¿ç”¨è¯„è®ºç»„ä»¶

   ```js
    <view class="comment-content-container" v-for="item in commentList" :key="item.comment_id">
         <CommentBox @commnetReply="commnetReply" :commentData="item"></CommentBox>
       </view>
   ```

   2. ä½¿ç”¨uni-load-moreç»„ä»¶ï¼Œå¯¹ç»„ä»¶å†…éƒ¨åˆå§‹åŒ–å±æ€§è¿›è¡Œè°ƒæ•´æ“ä½œ

      ```js
       <uni-load-more v-if="commentList.length===0 || commentList.length > 5" :status="loading" :contentText="{	contentdown: 'ä¸Šæ‹‰æ˜¾ç¤ºæ›´å¤š',
      						contentrefresh: 'æ­£åœ¨åŠ è½½...',
      						contentnomore: 'æ²¡æœ‰æ›´å¤šè¯„è®ºäº†'}"></uni-load-more>
      ```

   3. æ ¹æ®æ¡ä»¶è¿›è¡Œè¯„è®ºåˆ—è¡¨çš„è¿½åŠ æ“ä½œ

      ```js
       async _getCommentList () {
            const list = await this.$http.get_comments({
              articleId: this.articleId,
              page: this.page,
              pageSize: this.pageSize,
            })
            if (list.length === 0) {
              this.loading = 'noMore'
              return
            }
            let oldList = JSON.parse(JSON.stringify(this.commentList))
            oldList.push(...list)
            this.commentList = oldList
          },
      ```

### ä¸‰ã€æ·»åŠ è¯„è®ºå†…å®¹è¾“å…¥ç»„ä»¶

```js
 <!-- è¯„è®ºå†…å®¹è¾“å…¥ç»„ä»¶ -->
    <CommentMasker :showPopup="showPopup" @closePopupMasker="showPopup=$event" @sendCommentData="_sendCommentData">
    </CommentMasker>
```

### å››ã€å¤„ç†è¯„è®ºå‘å¸ƒä¸šåŠ¡

1. å›å¤äº‹ä»¶å‡½æ•°å¤„ç†

   ```js
     /* å¤„ç†å›å¤äº‹ä»¶å‡½æ•° */
       commnetReply (data) {
         this.replyData = {
           "comment_id": data.comment.comment_id,
           is_reply: data.isReply
         }
         // å½“å‰ä¸ºå›å¤å†…å®¹çš„æ—¶å€™æ·»åŠ å›å¤çš„ID
         data.comment.reply_id && (this.replyData.reply_id = data.comment.reply_id)
         this.openMaskerComment()
       },
   ```

2. å‰¯ä½œç”¨äº‹åŠ¡å¤„ç†

   ```js
       async _sendCommentData (content) {
         const {
           msg
         } = await this.$http.update_comment({
           userId: this.userInfo._id,
           articleId: this.articleId,
           content,
           ...this.replyData   // æ‰©å±•å½“å‰æ˜¯å¦ä¸ºå›å¤æŒ‡å®šè¯„è®ºå†…å®¹
         })
         uni.showToast({
           title: msg
         })
         // å¤„ç†å‰¯ä½œç”¨äº‹ç‰©
         this.showPopup = false;
         this.replyData = {};
         this.page = 1;
         this.commentList = [];
         this._getCommentList();
       }
   ```

   



## å…³æ³¨ç•Œé¢-ç»“æ„æ­å»º

### æ·»åŠ è·¯ç”±å®ˆå«

1. ä¸‰æ–¹æ’ä»¶ä½¿ç”¨

   æ–‡æ¡£åœ°å€ï¼š[https://hhyang.cn/v2/](https://hhyang.cn/v2/)

2. è¿›è¡Œå®ˆå«è§„åˆ™æ·»åŠ 

   ```js
   //å…¨å±€è·¯ç”±å‰ç½®å®ˆå«
   router.beforeEach((to, from, next) => {
     // åˆ¤æ–­å½“å‰é¡µé¢æ˜¯å¦éœ€è¦ç™»å½•å¹¶ä¸”ç°åœ¨æ˜¯æ²¡æœ‰ç™»å½•çš„çŠ¶æ€
     if (to.meta.needLogin && !store.state.userInfo) {
       next({
         name: "login",
         NAVTYPE: "push"  //è·³è½¬åˆ°æ™®é€šé¡µé¢ï¼Œæ–°å¼€ä¿ç•™å†å²è®°å½•
       })
     } else {
       next();
     }
   });
   ```

3. è°ƒæ•´è·¯ç”±æ¡è£…æ–¹å¼ä¸ºç»å¯¹è·¯å¾„

   ```js
   // listCardå¤„ç†è·¯å¾„è·³è½¬
         uni.navigateTo({url: `/pages/articleDetail/articleDetail?params=${JSON.stringify(params)}`})
   
   ```

   4. articleå†…è°ƒæ•´è·¯ç”±æ¥æ”¶æ–¹å¼

      ```js
       this.articleData = this.$Router.currentRoute.query.params
      ```

   5. å¤„ç†å°ç¨‹åºæ— æ³•å…¼å®¹é—®é¢˜

      ```js
        // #ifdef MP-WEIXIN
      		if(!this.$store.state.userInfo) {
      			uni.redirectTo({
      				url:'/pages/userInfo/login/login'
      			})
      			return 
      		}
            // #endif
      ```

### äºŒã€ç•Œé¢ç»“æ„æ ·å¼æ­å»º

â€‹			

```js
<view class="follow-container">
    <view class="follow-tab">
      <view class="follow-tab-box">
        <view class="follow-tab-item" :class="{active:currentIndex===0}">æ–‡ç« </view>
        <view class="follow-tab-item" :class="{active:currentIndex===1}">ä½œè€…</view>
      </view>
    </view>
    <!-- å†…å®¹åˆ‡æ¢åŒºåŸŸ -->
    <view class="follow-list-container">
      <swiper class="follow-list-swiper" :current="currentIndex">
        <swiper-item>
          <ListItem :isShowLoading="isShowLoading" :articleList="articleList" v-if="articleList.length"></ListItem>
          <view v-if="dataNone"  class="no-data">æš‚æ— æ”¶è—çš„æ–‡ç« </view>
        </swiper-item>
        <swiper-item>
          2
        </swiper-item>
      </swiper>
    </view>
  </view>
```

### ä¸‰ã€äº‘å‡½æ•°å®šä¹‰

```js
'use strict';
const db = uniCloud.database()
const $ = db.command.aggregate; // è·å–ä¸€ä¸ªèšåˆçš„æ“ä½œç¬¦

exports.main = async (event, context) => {
	const {
		userId
	} = event;

	let userInfo = await db.collection('user').doc(userId).get()
	let article_likes_ids = userInfo.data[0].article_likes_ids; // è·å–ç”¨æˆ·çš„æ”¶è—æ–‡ç« çš„æ•°ç»„

	const list = await db.collection('article')
		.aggregate()
		.addFields({
			// åˆ¤æ–­è¿™ä¸ªæ–‡ç« çš„æ•°ç»„æ˜¯å¦åŒ…å«æ–‡ç« çš„_id ,$_id æŒ‡çš„æ˜¯æ–‡ç« åˆ—è¡¨é‡Œé¢çš„_id,å¦‚æœåŒ…å«ï¼Œè¿”å›trueï¼Œå¦åˆ™ï¼Œè¿”å›falseï¼Œåœ¨è¿™ä¸ªé‡Œé¢æ˜¯è¿‡æ»¤æŸ¥è¯¢çš„æ¯ä¸€æ¡è®°å½•å€¼
			is_like: $.in(['$_id', article_likes_ids])
		})
		.project({
			content: 0
		})
		.match({
			is_like:true
		})
		.end();

	//è¿”å›æ•°æ®ç»™å®¢æˆ·ç«¯
	return {
		code: 0,
		msg: "è¯·æ±‚æˆåŠŸ",
		data: list.data
	}
};

```

## å…³æ³¨ç•Œé¢-ä½œè€…ç»„ä»¶åˆ¶ä½œ

### ä¸€ã€å…¨å±€äº‹ä»¶ç›‘å¬

> â€‹		å¤„ç†å…³æ³¨ç•Œé¢æ•°æ®ä¸åˆ·æ–°é—®é¢˜ï¼Œä½¿ç”¨uni.$emitäº‹ä»¶æ³¨å†Œå…¨å±€äº‹ä»¶

```js
     // saveLikeç»„ä»¶
     uni.$emit('updateArticle')

    // followPageç•Œé¢

  // todo æ²¡æœ‰è¿™ä¸ªå†å²è®°å½•æ ˆçš„æ—¶å€™ä¸ä¼šè§¦å‘è¿™ä¸ªäº‹ä»¶
    uni.$on('updateArticle',(e)=> {
      this._getFollowArticle();
    })
```

### äºŒã€ä½œè€…ç»„ä»¶ç»“æ„æ­å»º

1. å…³è”swiperæ»‘åŠ¨ç»„ä»¶
2. ç»“æ„æ ·å¼æ·»åŠ    

### ä¸‰ã€äº‘å‡½æ•°å®šä¹‰

```js
'use strict';
const db = uniCloud.database()
const $ = db.command.aggregate; // è·å–ä¸€ä¸ªèšåˆçš„æ“ä½œç¬¦

exports.main = async (event, context) => {
	const {
		userId
	} = event;

	let userInfo = await db.collection('user').doc(userId).get()
	let article_likes_ids = userInfo.data[0].article_likes_ids; // è·å–ç”¨æˆ·çš„æ”¶è—æ–‡ç« çš„æ•°ç»„

	const list = await db.collection('article')
		.aggregate()
		.addFields({
			// åˆ¤æ–­è¿™ä¸ªæ–‡ç« çš„æ•°ç»„æ˜¯å¦åŒ…å«æ–‡ç« çš„_id ,$_id æŒ‡çš„æ˜¯æ–‡ç« åˆ—è¡¨é‡Œé¢çš„_id,å¦‚æœåŒ…å«ï¼Œè¿”å›trueï¼Œå¦åˆ™ï¼Œè¿”å›falseï¼Œåœ¨è¿™ä¸ªé‡Œé¢æ˜¯è¿‡æ»¤æŸ¥è¯¢çš„æ¯ä¸€æ¡è®°å½•å€¼
			is_like: $.in(['$_id', article_likes_ids])
		})
		.project({
			content: 0
		})
		.match({
			is_like:true
		})
		.end();

	//è¿”å›æ•°æ®ç»™å®¢æˆ·ç«¯
	return {
		code: 0,
		msg: "è¯·æ±‚æˆåŠŸ",
		data: list.data
	}
};

```

### å››ã€å®¢æˆ·ç«¯æ¸²æŸ“

> â€‹	å°†è·å–åˆ°çš„å†…å®¹è¿›è¡Œæ¸²æŸ“æ“ä½œ

### äº”ã€æ•°æ®åŒæ­¥

â€‹		å®šä¹‰å…¨å±€äº‹ä»¶ï¼Œå®ç°ä¿®æ”¹å…³æ³¨ä½œè€…æ—¶è§¦å‘foll_authoräº‹ä»¶ä»æ–°è°ƒç”¨

```js
uni.$on('updateAuthor',(e)=> {
      this._getAuthorList();
    })
```

## ä¸ªäººä¸­å¿ƒ-é¡µé¢ç»“æ„æ­å»º

### ä¸€ã€æœªç™»å½•çŠ¶æ€

1. å±•ç¤ºæœªç™»å½•æç¤ºç»“æ„ï¼›
2. åœ¨æœªç™»å½•çŠ¶æ€ä¸‹å¯å®ç°ç•Œé¢è·³è½¬

### äºŒã€ç™»å½•çŠ¶æ€

1. å±•ç¤ºç”¨æˆ·ç™»å½•ä¿¡æ¯å†…å®¹
2. æ·»åŠ é€€å‡ºæŒ‰é’®ï¼Œå®šä¹‰é€€å‡ºå‡½æ•°

## ä¸ªäººä¸­å¿ƒ-æˆ‘çš„æ–‡ç« 

### ä¸€ã€è¿›è¡Œç”¨æˆ·ä¿¡æ¯æ¸²æŸ“

### äºŒã€å®Œæˆappå‡çº§ç‰ˆæœ¬é€»è¾‘å¤„ç†

1. åˆå§‹åŒ–onLoadäº‹ä»¶è¿›è¡Œç‰ˆæœ¬æ£€æµ‹

   ```js
     // !åˆ¤æ–­æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬è¿›è¡Œä¸‹è½½åŠè·å–å½“å‰çš„ç‰ˆæœ¬
       // #ifdef APP-PLUS
       uni.getSystemInfo({
         success: (res) => {
           if (res.platform == "android") {
             plus.runtime.getProperty(plus.runtime.appid, wgtinfo => {
               this.currentVersion = wgitinfo;
               this._checkVersion();
             })
           }
         }
       })
       // #endif
   ```

2. è¿›è¡Œç‰ˆæœ¬æ£€æµ‹ï¼Œåˆ¤æ–­å½“å‰ç‰ˆæœ¬æ˜¯å¦å°äºæœ€æ–°ç‰ˆæœ¬

   ```js
    // appä¸­åˆ¤æ–­æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
       async _checkVersion() {
         const {version,downLoadLinkUrl} = await this.$http.get_current_version();
         if(version > this.currentVersion) {
           this.haveNewVersion = true;
           this.downLoadLinkUrl = downLoadLinkUrl
         }
       },
   ```

   

3. ä¸‹è½½æœ€æ–°ç‰ˆæœ¬å†…å®¹è¿›è¡Œå®‰è£…å¤„ç†

   ```js
    // è·å–æœ€æ–°ç‰ˆæœ¬appä¸‹è½½
       _getNewVersion() {
         uni.showLoading({title:'ä¸‹è½½ä¸­ï¼Œè¯·ç¨å'});
          var dtask = plus.downloader.createDownload(this.downLoadLinkUrl, {}, function (d, status) {
           // ä¸‹è½½å®Œæˆ  
           uni.hideLoading({})
           if (status == 200) {
             plus.runtime.install(plus.io.convertLocalFileSystemURL(d.filename), {}, {}, function (error) {
               uni.showToast({
                 title: 'å®‰è£…å¤±è´¥',
                 duration: 1500,
                 icon: 'none'
               });
             })
           } else {
             uni.showToast({
               title: 'æ›´æ–°å¤±è´¥',
               duration: 1500,
               icon: 'none'
             });
           }
         });
         dtask.start();
       }
   ```

### ä¸‰ã€æˆ‘çš„æ–‡ç« å¤„ç†

1. åˆ›å»ºé¡µé¢

2. ç»„ä»¶å¼•å…¥

3. æ•°æ®è·å–-äº‘å‡½æ•°å®šä¹‰

   ```js
   'use strict';
   const db = uniCloud.database()
   const dbCmd = db.command;
   
   exports.main = async (event, context) => {
   	const {
   		userId
   	} = event;
   
   	let userInfo = await db.collection('user').doc(userId).get()
   	let article_ids = userInfo.data[0].article_ids; 
   
   	const list = await db.collection('article')
   		.aggregate()
   		.project({
   			content: 0,
   			comments:0
   		})
   		.match({
   			id:dbCmd.in(article_ids)
   		})
   		.end();
   
   	//è¿”å›æ•°æ®ç»™å®¢æˆ·ç«¯
   	return {
   		code: 0,
   		msg: "è¯·æ±‚æˆåŠŸ",
   		data: list.data
   	}
   };
   
   ```

   

## ä¸ªäººä¸­å¿ƒ-æ„è§åé¦ˆ

### ä¸€ã€é¡µé¢ç»“æ„æ­å»º

1. ç»“æ„åˆ›å»º

2. æ ·å¼å¤„ç†

   ```css
   .feedback-title {
       margin: 30rpx;
       margin-bottom: 0;
       font-size: 28rpx;
       color: #666;
   }
   
   .feedback-content {
       margin: 30rpx;
       padding: 20rpx;
       box-sizing: border-box;
       border: 1px solid #eee;
       .feedback-textarea {
           font-size: 24rpx;
           width: 100%;
           height: 200rpx;
       }
   }
   
   .feedback-image-box {
       display: flex;
       flex-wrap: wrap;
       padding: 20rpx;
       .feedback-image-item {
           position: relative;
           width: 33.33%;
           height: 0;
           padding-top: 33.33%;
           box-sizing: border-box;
           .close-icon {
               @include flex(center);
               right: 0;
               top: 0;
               width: 44rpx;
               height: 44rpx;
               position: absolute;
               border-radius: 50%;
               z-index: 2;
               background-color: $base-color;
           }
           .image-box {
               @include flex(center);
               top: 10rpx;
               right: 10rpx;
               bottom: 10rpx;
               left: 10rpx;
               border: 1px solid #eee;
               border-radius: 10rpx;
               overflow: hidden;
               position: absolute;
               image {
                   width: 100%;
                   height: 100%;
               }
           }
       }
   }
   
   .feedback-button {
       margin: 0 30rpx;
       background-color: $base-color;
   }
   ```

### äºŒã€æ–°å¢å›¾ç‰‡æ“ä½œ

1. chooseImageå‚è€ƒåœ°å€ï¼š[https://uniapp.dcloud.io/api/media/image?id=chooseimage](https://uniapp.dcloud.io/api/media/image?id=chooseimage)

2. ä¸ºå‰ç«¯UIè¿›è¡Œå›¾ç‰‡å®šä¹‰

   ```js
     const count = 5 - this.imageList.length;
         uni.chooseImage({
           count,
           success: res => {
             const tempFilePaths = res.tempFilePaths;
             tempFilePaths.forEach((url, index) => {
               if (index < count) {
                 this.imageList.push({
                   url,
                   name: res.tempFiles[index].name
                 })
               }
             })
           }
         })
   ```

   

### ä¸‰ã€å‘é€æ•°æ®åˆ°äº‘å‡½æ•°

1. å›¾ç‰‡ç›´ä¼ å‚è€ƒåœ°å€ï¼š[https://uniapp.dcloud.io/uniCloud/storage?id=clouduploadfile](https://uniapp.dcloud.io/uniCloud/storage?id=clouduploadfile)

2. æ”¶é›†å›¾ç‰‡ä¸Šä¼ æˆåŠŸä¹‹åçš„è®¿é—®åœ°å€

   ```js
    return this.imageList.map(item => {
           return new Promise(async resolve => {
             const result = await uniCloud.uploadFile({
               filePath: item.url,
               cloudPath: item.name
             })
             resolve(result.fileID)
           })
         })
   ```

3.  å®šä¹‰äº‘å‡½æ•°

   ```js
   'use strict';
   const db = uniCloud.database();
   exports.main = async (event, context) => {
   	const {
   		userId,
   		feedbackImageList,
   		content
   	} = event
   	
   	await db.collection('feedback').add({
   		user_id:userId,
   		feedbackImageList,
   		content
   	})
   	return {
   		code:0,
   		data:{
   			msg:"æäº¤åé¦ˆæˆåŠŸ"
   		}
   	}
   };
   ```

### å››ã€ç”¨æˆ·å¤´åƒä¿®æ”¹

> â€‹		è·å–ä¿®æ”¹å¤´åƒå†…å®¹ï¼Œä¸Šä¼ äº‘å‡½æ•° ï¼Œè¿›è¡Œå›¾ç‰‡çš„ä¿®æ”¹ï¼ŒåŠåŸå›¾ç‰‡çš„åˆ é™¤æ“ä½œ

```js
'use strict';
const db = uniCloud.database();
exports.main = async (event, context) => {
	const {
		userId,
		filePath
	} = event;
	
	const user = await db.collection('user').doc(userId).get()
	const oldImgList = user.data[0].avatar
	try {
		await uniCloud.deleteFile({
			fileList: [oldImgList],
		});
	}catch(e) {
		console.log(e)
	}
	 
	 await db.collection('user').doc(userId).update({
		avatar:filePath
	})

	//è¿”å›æ•°æ®ç»™å®¢æˆ·ç«¯
	return {
		code: 0,
		data: {
			msg:"ä¿®æ”¹å¤´åƒæˆåŠŸ",
		}
	}
};

```

â€‹			

## å‘å¸ƒ-wapç«¯å‘è¡Œæ‰“åŒ…

> æ‰“åŒ…å‚è€ƒåœ°å€ï¼š[https://uniapp.dcloud.io/collocation/manifest?id=h5](https://uniapp.dcloud.io/collocation/manifest?id=h5)

![image-20210821113024703](https://tva1.sinaimg.cn/large/008i3skNly1gto93ef2mtj60xl0u0mzc02.jpg)

#### unicloudç½‘é¡µæ‰˜ç®¡é…ç½®

> ä½¿ç”¨unicloudå‰ç«¯ç½‘é¡µæ‰˜ç®¡çš„è¯éœ€è¦è¿›è¡Œå®‰å…¨åŸŸåé…ç½®

å‚è€ƒåœ°å€ï¼š[https://uniapp.dcloud.io/uniCloud/hosting](https://uniapp.dcloud.io/uniCloud/hosting)

## å‘å¸ƒ-å¾®ä¿¡å°ç¨‹åºå‘å¸ƒ

> æ‰“åŒ…å‚è€ƒåœ°å€ï¼š[https://uniapp.dcloud.io/collocation/manifest?id=h5](https://uniapp.dcloud.io/collocation/manifest?id=h5)

1. æ‰“åŒ…é…ç½®æ–‡ä»¶

   - è·å–å°ç¨‹åºIDï¼›

   - è¿›è¡Œå®‰å…¨åŸŸåé…ç½®

     ![image-20210821165139206](https://tva1.sinaimg.cn/large/008i3skNly1gtoidmichbj60zi0pmwgn02.jpg)

2. å°ç¨‹åºå‘å¸ƒ

3. æäº¤é¢„å‘å¸ƒç‰ˆæœ¬

4. æäº¤å®¡æ ¸

   å‚è€ƒåœ°å€ï¼šhttps://mp.weixin.qq.com/wxamp/wacodepage/getcodepage?token=1374043880&lang=zh_CN

## å‘å¸ƒ-appå®‰å“ç³»ç»Ÿåº”ç”¨æ‰“åŒ…å‘å¸ƒ

### ä¸€ã€é…ç½®

1. åŸºç¡€é…ç½®

   ![image-20210821192748903](https://tva1.sinaimg.cn/large/008i3skNly1gtomw2nqlvj612a0fqta302.jpg)

2. å›¾æ ‡ä½¿ç”¨

   > ä½¿ç”¨1024*1024å›¾æ ‡

3. å…¶ä»–é…ç½®æš‚æ—¶å¿½ç•¥

### äºŒã€è¯ä¹¦ä¸‹è½½

> è¯ä¹¦ä¸‹è½½åœ°å€ï¼š[https://www.dibaqu.com/utils/android-cert](https://www.dibaqu.com/utils/android-cert)

